<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .scan-button {
            width: 100%;
            padding: 16px;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
            position: relative;
            z-index: 1000;
        }
        
        .scan-button:active {
            opacity: 0.8;
            transform: scale(0.98);
        }
        
        .scan-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .scan-button.scanning {
            background: #dc3545;
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            width: calc(100% - 40px);
            z-index: 10000;
            margin-bottom: 0;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
            }
            50% {
                box-shadow: 0 4px 25px rgba(220, 53, 69, 0.7);
            }
        }
        
        .video-container {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
            display: none;
        }
        
        .video-container.active {
            display: block;
        }
        
        #video {
            width: 100%;
            max-width: 100%;
            border-radius: 10px;
            display: block;
        }
        
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .scan-frame {
            width: 80%;
            max-width: 300px;
            height: 200px;
            border: 3px solid #0088cc;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }
        
        .scan-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(to right, transparent, #00ff00, transparent);
            animation: scanLine 2s linear infinite;
            box-shadow: 0 0 10px #00ff00;
        }
        
        @keyframes scanLine {
            0% {
                top: 10%;
            }
            50% {
                top: 50%;
            }
            100% {
                top: 90%;
            }
        }
        
        .scan-corners {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 4px solid #00ff00;
        }
        
        .corner.top-left {
            top: -4px;
            left: -4px;
            border-right: none;
            border-bottom: none;
            border-top-left-radius: 10px;
        }
        
        .corner.top-right {
            top: -4px;
            right: -4px;
            border-left: none;
            border-bottom: none;
            border-top-right-radius: 10px;
        }
        
        .corner.bottom-left {
            bottom: -4px;
            left: -4px;
            border-right: none;
            border-top: none;
            border-bottom-left-radius: 10px;
        }
        
        .corner.bottom-right {
            bottom: -4px;
            right: -4px;
            border-left: none;
            border-top: none;
            border-bottom-right-radius: 10px;
        }
        
        .scan-hint {
            position: absolute;
            bottom: -50px;
            left: 0;
            right: 0;
            text-align: center;
            color: #ffffff;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }
        
        .scan-success {
            animation: scanSuccess 0.5s ease-in-out;
        }
        
        @keyframes scanSuccess {
            0%, 100% {
                border-color: #0088cc;
            }
            50% {
                border-color: #00ff00;
                box-shadow: 0 0 20px #00ff00;
            }
        }
        
        .capture-button {
            width: 100%;
            padding: 14px;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            display: none;
        }
        
        .capture-button.active {
            display: block;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none;
        }
        
        .status.active {
            display: block;
        }
        
        .status.scanning {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status.found {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        
        .product-info {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .product-info.active {
            display: block;
        }
        
        .product-image {
            width: 100%;
            max-width: 200px;
            height: 200px;
            object-fit: contain;
            border-radius: 10px;
            margin: 0 auto 15px;
            display: block;
            background: #f5f5f5;
        }
        
        .product-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .product-brand {
            color: var(--tg-theme-hint-color, #999999);
            margin-bottom: 10px;
        }
        
        .product-barcode {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
            margin-bottom: 15px;
            font-family: monospace;
        }
        
        .product-category {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .product-source {
            text-align: center;
            color: var(--tg-theme-hint-color, #999999);
            font-size: 12px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }
        
        .partial-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .partial-info-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #856404;
        }
        
        .nutrition {
            margin-top: 15px;
        }
        
        .nutrition-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }
        
        .nutrition-item:last-child {
            border-bottom: none;
        }
        
        .nutrition-label {
            font-weight: 500;
        }
        
        .nutrition-value {
            color: var(--tg-theme-link-color, #0088cc);
        }
        
        .add-button {
            width: 100%;
            padding: 14px;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }
        
        .close-button {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .manual-input {
            margin-top: 20px;
            padding: 15px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 10px;
        }
        
        .manual-input-title {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .barcode-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 8px;
            font-size: 16px;
            font-family: monospace;
        }
        
        .search-button {
            padding: 12px 20px;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .search-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .divider {
            text-align: center;
            margin: 20px 0;
            color: var(--tg-theme-hint-color, #999999);
            position: relative;
        }
        
        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--tg-theme-hint-color, #e0e0e0);
        }
        
        .divider::before {
            left: 0;
        }
        
        .divider::after {
            right: 0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 3px solid var(--tg-theme-hint-color, #f3f3f3);
            border-top: 3px solid var(--tg-theme-button-color, #0088cc);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∑ –°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤</h1>
        
        <button class="scan-button" id="scanButton">–û—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É</button>
        
        <div class="status scanning" id="status">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>
        
        <div class="video-container" id="videoContainer">
            <video id="video" autoplay playsinline></video>
            <div class="scan-overlay">
                <div class="scan-frame" id="scanFrame">
                    <div class="scan-corners">
                        <div class="corner top-left"></div>
                        <div class="corner top-right"></div>
                        <div class="corner bottom-left"></div>
                        <div class="corner bottom-right"></div>
                    </div>
                    <div class="scan-line"></div>
                </div>
                <div class="scan-hint" id="scanHint">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥</div>
            </div>
        </div>
        
        <button class="capture-button" id="captureButton">üì∏ –ó–∞—Ö–≤–∞—Ç–∏—Ç—å –∫–∞–¥—Ä</button>
        
        <div class="divider">–∏–ª–∏</div>
        
        <div class="manual-input">
            <div class="manual-input-title">‚úçÔ∏è –í–≤–µ—Å—Ç–∏ —à—Ç—Ä–∏—Ö-–∫–æ–¥ –≤—Ä—É—á–Ω—É—é</div>
            <div class="input-group">
                <input type="text" class="barcode-input" id="barcodeInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥" inputmode="numeric" pattern="[0-9]*">
                <button class="search-button" id="searchButton">–ù–∞–π—Ç–∏</button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>–ò—â—É –ø—Ä–æ–¥—É–∫—Ç...</div>
        </div>
        
        <div class="product-info" id="productInfo">
            <img class="product-image" id="productImage" style="display: none;" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞">
            <div class="product-name" id="productName"></div>
            <div class="product-brand" id="productBrand"></div>
            <div class="product-barcode" id="productBarcode"></div>
            <div class="product-category" id="productCategory"></div>
            
            <div class="nutrition">
                <div class="nutrition-item">
                    <span class="nutrition-label">üî• –ö–∞–ª–æ—Ä–∏–∏:</span>
                    <span class="nutrition-value" id="calories">-</span>
                </div>
                <div class="nutrition-item">
                    <span class="nutrition-label">ü•© –ë–µ–ª–∫–∏:</span>
                    <span class="nutrition-value" id="proteins">-</span>
                </div>
                <div class="nutrition-item">
                    <span class="nutrition-label">üßà –ñ–∏—Ä—ã:</span>
                    <span class="nutrition-value" id="fats">-</span>
                </div>
                <div class="nutrition-item">
                    <span class="nutrition-label">üçû –£–≥–ª–µ–≤–æ–¥—ã:</span>
                    <span class="nutrition-value" id="carbs">-</span>
                </div>
            </div>
            
            <div class="product-source" id="productSource"></div>
            
            <div class="partial-info" id="partialInfo" style="display: none;">
                <div class="partial-info-title">‚ÑπÔ∏è –ß–∞—Å—Ç–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                <div id="partialInfoText"></div>
            </div>
            
            <button class="add-button" id="addButton">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫</button>
            <button class="close-button" id="closeButton">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const scanButton = document.getElementById('scanButton');
        const video = document.getElementById('video');
        const videoContainer = document.getElementById('videoContainer');
        const scanFrame = document.getElementById('scanFrame');
        const scanHint = document.getElementById('scanHint');
        const captureButton = document.getElementById('captureButton');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        const productInfo = document.getElementById('productInfo');
        const productImage = document.getElementById('productImage');
        const productName = document.getElementById('productName');
        const productBrand = document.getElementById('productBrand');
        const productBarcode = document.getElementById('productBarcode');
        const productCategory = document.getElementById('productCategory');
        const productSource = document.getElementById('productSource');
        const partialInfo = document.getElementById('partialInfo');
        const partialInfoText = document.getElementById('partialInfoText');
        const caloriesEl = document.getElementById('calories');
        const proteinsEl = document.getElementById('proteins');
        const fatsEl = document.getElementById('fats');
        const carbsEl = document.getElementById('carbs');
        const addButton = document.getElementById('addButton');
        const closeButton = document.getElementById('closeButton');
        const barcodeInput = document.getElementById('barcodeInput');
        const searchButton = document.getElementById('searchButton');

        let stream = null;
        let codeReader = null;
        let scanning = false;
        let currentBarcode = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ZXing
        codeReader = new ZXing.BrowserMultiFormatReader();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞ –ø–æ –≤–≤–µ–¥–µ–Ω–Ω–æ–º—É —à—Ç—Ä–∏—Ö-–∫–æ–¥—É
        searchButton.addEventListener('click', () => {
            const barcode = barcodeInput.value.trim();
            if (barcode && /^\d+$/.test(barcode)) {
                handleManualBarcode(barcode);
            } else {
                tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —à—Ç—Ä–∏—Ö-–∫–æ–¥ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)');
            }
        });
        
        // –ü–æ–∏—Å–∫ –ø–æ Enter
        barcodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchButton.click();
            }
        });

        scanButton.addEventListener('click', async () => {
            if (scanning) {
                stopScanning();
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–¥—É–∫—Ç–µ –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞
                productInfo.classList.remove('active');
            } else {
                startScanning();
            }
        });

        closeButton.addEventListener('click', () => {
            productInfo.classList.remove('active');
            // –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞, –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ—ë —Ç–æ–∂–µ
            if (scanning) {
                stopScanning();
            }
        });
        
        captureButton.addEventListener('click', async () => {
            if (!scanning || !video.videoWidth) return;
            
            // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∫–∞–¥—Ä–∞
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —à—Ç—Ä–∏—Ö-–∫–æ–¥ –∏–∑ –∫–∞–¥—Ä–∞
                const result = await codeReader.decodeFromImageElement(video);
                if (result) {
                    handleBarcodeFound(result.getText());
                } else {
                    tg.showAlert('–®—Ç—Ä–∏—Ö-–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —ç—Ç–æ–º –∫–∞–¥—Ä–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞—Ö–≤–∞—Ç–µ –∫–∞–¥—Ä–∞:', error);
                tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —à—Ç—Ä–∏—Ö-–∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.');
            }
        });

        addButton.addEventListener('click', async () => {
            if (!currentBarcode) return;
            
            tg.showAlert('–î–æ–±–∞–≤–ª—è—é –ø—Ä–æ–¥—É–∫—Ç –≤ –¥–Ω–µ–≤–Ω–∏–∫...');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –±–æ—Ç —á–µ—Ä–µ–∑ Telegram Web App API
            // –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ–ª—É—á–µ–Ω—ã –±–æ—Ç–æ–º —á–µ—Ä–µ–∑ callback_query
            tg.sendData(JSON.stringify({
                action: 'add_product',
                barcode: currentBarcode
            }));
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º Mini App –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            setTimeout(() => {
                tg.close();
            }, 300);
        });

        async function startScanning() {
            try {
                scanButton.disabled = true;
                scanButton.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–∞–º–µ—Ä–µ...';
                
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ getUserMedia
                // –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
                let stream = null;
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: { ideal: 'environment' }, // –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    
                    // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –ø–æ—Ç–æ–∫, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –¥–ª—è –≤–∏–¥–µ–æ
                    video.srcObject = stream;
                    await video.play();
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ç–æ–∫ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
                    window.currentStream = stream;
                } catch (mediaError) {
                    console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', mediaError);
                    
                    // –ü—Ä–æ–±—É–µ–º –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–∞ —Ç–∏–ø –∫–∞–º–µ—Ä—ã
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            video: true 
                        });
                        video.srcObject = stream;
                        await video.play();
                        window.currentStream = stream;
                        tg.showAlert('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –∫–∞–º–µ—Ä–∞. –î–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É.');
                    } catch (fallbackError) {
                        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ (fallback):', fallbackError);
                        let errorMsg = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.\n\n';
                        
                        if (fallbackError.name === 'NotAllowedError' || fallbackError.name === 'PermissionDeniedError') {
                            errorMsg += '–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ.\n';
                            errorMsg += '–ü—Ä–æ–≤–µ—Ä—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ —Ä–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.';
                        } else if (fallbackError.name === 'NotFoundError' || fallbackError.name === 'DevicesNotFoundError') {
                            errorMsg += '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.\n';
                            errorMsg += '–ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ –Ω–∏–∂–µ.';
                        } else if (fallbackError.name === 'NotReadableError' || fallbackError.name === 'TrackStartError') {
                            errorMsg += '–ö–∞–º–µ—Ä–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.\n';
                            errorMsg += '–ó–∞–∫—Ä–æ–π –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –∫–∞–º–µ—Ä—É.';
                        } else {
                            errorMsg += `–û—à–∏–±–∫–∞: ${fallbackError.message || fallbackError.name}\n`;
                            errorMsg += '–ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ –Ω–∏–∂–µ.';
                        }
                        
                    showError(errorMsg);
                    scanButton.disabled = false;
                    scanButton.textContent = '–û—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É';
                    scanButton.classList.remove('scanning');
                    return;
                    }
                }
                
                // –¢–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã
                let devices = [];
                try {
                    devices = await codeReader.listVideoInputDevices();
                } catch (listError) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä:', listError);
                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É —Å —Ç–µ–∫—É—â–∏–º –ø–æ—Ç–æ–∫–æ–º
                }
                
                if (devices.length === 0) {
                    // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç, –Ω–æ –ø–æ—Ç–æ–∫ –µ—Å—Ç—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫
                    if (stream) {
                        console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫ –∫–∞–º–µ—Ä—ã');
                    } else {
                        showError('–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ –Ω–∏–∂–µ.');
                        scanButton.disabled = false;
                        scanButton.textContent = '–û—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É';
                        scanButton.classList.remove('scanning');
                        return;
                    }
                }

                // –í—ã–±–∏—Ä–∞–µ–º –∫–∞–º–µ—Ä—É
                let deviceId = null;
                
                if (devices.length > 0) {
                    // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
                    deviceId = devices.find(d => {
                        const label = d.label.toLowerCase();
                        return label.includes('back') || 
                               label.includes('rear') || 
                               label.includes('environment') ||
                               label.includes('facing back') ||
                               (label.includes('camera') && !label.includes('front'));
                    })?.deviceId;
                    
                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∑–∞–¥–Ω—é—é, –∏—â–µ–º –∫–∞–º–µ—Ä—É –∫–æ—Ç–æ—Ä–∞—è –ù–ï —è–≤–ª—è–µ—Ç—Å—è —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π
                    if (!deviceId) {
                        deviceId = devices.find(d => {
                            const label = d.label.toLowerCase();
                            return !label.includes('front') && 
                                   !label.includes('user') && 
                                   !label.includes('selfie') &&
                                   !label.includes('facing user');
                        })?.deviceId;
                    }
                    
                    // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞—à–ª–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª—é–±—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –∫–∞–º–µ—Ä—É
                    if (!deviceId) {
                        deviceId = devices[0].deviceId;
                        const label = devices[0].label.toLowerCase();
                        if (label.includes('front') || label.includes('user') || label.includes('selfie')) {
                            tg.showAlert('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞. –î–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É.');
                        }
                    }
                } else {
                    // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø—É—Å—Ç, –Ω–æ –ø–æ—Ç–æ–∫ –µ—Å—Ç—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º undefined
                    // ZXing –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫
                    deviceId = undefined;
                }

                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥–µ–æ
                videoContainer.classList.add('active');
                status.classList.add('active', 'scanning');
                status.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥';
                scanHint.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥';
                captureButton.classList.add('active');
                
                let lastBarcodeTime = 0;
                let barcodeFound = false;
                
                // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                const handleScanResult = (result, err) => {
                    if (result) {
                        const barcode = result.getText();
                        const now = Date.now();
                        
                        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
                        if (now - lastBarcodeTime > 1000 && !barcodeFound) {
                            lastBarcodeTime = now;
                            barcodeFound = true;
                            
                            // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                            scanFrame.classList.add('scan-success');
                            scanHint.textContent = '‚úÖ –®—Ç—Ä–∏—Ö-–∫–æ–¥ –Ω–∞–π–¥–µ–Ω!';
                            scanHint.style.color = '#00ff00';
                            
                            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
                            setTimeout(() => {
                                handleBarcodeFound(barcode);
                            }, 500);
                        }
                    } else {
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –µ—Å–ª–∏ —à—Ç—Ä–∏—Ö-–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω
                        if (err && err.name === 'NotFoundException') {
                            if (barcodeFound && Date.now() - lastBarcodeTime > 2000) {
                                barcodeFound = false;
                                scanFrame.classList.remove('scan-success');
                                scanHint.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥';
                                scanHint.style.color = '#ffffff';
                            }
                        }
                    }
                };
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                if (deviceId !== undefined) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
                    codeReader.decodeFromVideoDevice(deviceId, 'video', handleScanResult);
                } else {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫ –∏–∑ video —ç–ª–µ–º–µ–Ω—Ç–∞
                    codeReader.decodeFromVideoElement(video, handleScanResult);
                }

                scanning = true;
                scanButton.disabled = false;
                scanButton.textContent = '‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ';
                scanButton.classList.add('scanning');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–∞–º–µ—Ä—ã:', error);
                let errorMsg = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É.\n\n';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMsg += '‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ.\n';
                    errorMsg += '–ü—Ä–æ–≤–µ—Ä—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ —Ä–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMsg += '‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.\n';
                    errorMsg += '–ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ –Ω–∏–∂–µ.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMsg += '‚ùå –ö–∞–º–µ—Ä–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.\n';
                    errorMsg += '–ó–∞–∫—Ä–æ–π –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –∫–∞–º–µ—Ä—É.';
                } else {
                    errorMsg += `‚ùå –û—à–∏–±–∫–∞: ${error.message || error.name}\n`;
                    errorMsg += '–ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ –Ω–∏–∂–µ.';
                }
                
                showError(errorMsg);
                scanButton.disabled = false;
                scanButton.textContent = '–û—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É';
                scanButton.classList.remove('scanning');
            }
        }

        function stopScanning() {
            if (codeReader) {
                codeReader.reset();
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏ –ø–æ—Ç–æ–∫–∞
            if (window.currentStream) {
                window.currentStream.getTracks().forEach(track => track.stop());
                window.currentStream = null;
            }
            
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            videoContainer.classList.remove('active');
            captureButton.classList.remove('active');
            status.classList.remove('active');
            scanFrame.classList.remove('scan-success');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–º–∫–∏ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏
            scanHint.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥';
            scanHint.style.color = '#ffffff';
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ
            video.pause();
            video.srcObject = null;
            
            scanning = false;
            scanButton.disabled = false;
            scanButton.textContent = '–û—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É';
            scanButton.classList.remove('scanning');
        }

        async function handleBarcodeFound(barcode) {
            if (barcode) {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ
                if (scanning) {
                    stopScanning();
                }
                
                currentBarcode = barcode;
                
                status.classList.add('active', 'found');
                status.textContent = `‚úÖ –ù–∞–π–¥–µ–Ω —à—Ç—Ä–∏—Ö-–∫–æ–¥: ${barcode}`;
                
                loading.classList.add('active');
                loading.querySelector('div:last-child').textContent = '–ò—â—É –ø—Ä–æ–¥—É–∫—Ç –≤ –±–∞–∑–∞—Ö –¥–∞–Ω–Ω—ã—Ö...';
                
                // –ò—â–µ–º –ø—Ä–æ–¥—É–∫—Ç –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
                try {
                    const productData = await searchProductMultipleSources(barcode);
                    
                    if (productData && (productData.success || productData.partial)) {
                        displayProduct(productData);
                    } else {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ö–æ—Ç—è –±—ã —à—Ç—Ä–∏—Ö-–∫–æ–¥
                        displayPartialInfo(barcode, '–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–∞—Ö –¥–∞–Ω–Ω—ã—Ö, –Ω–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω.');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø—Ä–æ–¥—É–∫—Ç–∞:', error);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ö–æ—Ç—è –±—ã —à—Ç—Ä–∏—Ö-–∫–æ–¥
                    displayPartialInfo(barcode, `–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ: ${error.message}. –ù–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω.`);
                } finally {
                    loading.classList.remove('active');
                }
            }
        }

        async function searchProductMultipleSources(barcode) {
            // –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
            const sources = [
                searchOpenFoodFacts,
                searchUPCitemdb,
                searchBarcodeLookup
            ];
            
            for (const searchFunc of sources) {
                try {
                    const result = await searchFunc(barcode);
                    if (result && (result.success || result.partial)) {
                        return result;
                    }
                } catch (error) {
                    console.error(`–û—à–∏–±–∫–∞ –≤ ${searchFunc.name}:`, error);
                    continue;
                }
            }
            
            // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —á–∞—Å—Ç–∏—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            return {
                partial: true,
                barcode: barcode,
                name: `–ü—Ä–æ–¥—É–∫—Ç —Å–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–º ${barcode}`,
                message: '–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–∞—Ö –¥–∞–Ω–Ω—ã—Ö'
            };
        }
        
        async function searchOpenFoodFacts(barcode) {
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();
                
                if (data.status === 1 && data.product) {
                    const product = data.product;
                    
                    const productName = product.product_name || product.product_name_en || product.product_name_ru || 
                                     product.product_name_fr || product.abbreviated_product_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç';
                    const brand = product.brands || product.brand || '';
                    const category = product.categories || product.categories_tags?.[0] || '';
                    const imageUrl = product.image_url || product.image_front_url || product.image_front_small_url || '';
                    
                    const nutriments = product.nutriments || {};
                    const calories = nutriments['energy-kcal_100g'] || nutriments['energy-kcal'] || 
                                   (nutriments.energy ? Math.round(nutriments.energy / 4.184) : null);
                    const proteins = nutriments.proteins_100g || nutriments.proteins;
                    const fats = nutriments.fat_100g || nutriments.fats_100g || nutriments.fat;
                    const carbs = nutriments.carbohydrates_100g || nutriments.carbs_100g || nutriments.carbohydrates;
                    
                    const hasNutrition = calories || proteins || fats || carbs;
                    
                    return {
                        success: hasNutrition,
                        partial: !hasNutrition,
                        name: productName,
                        brand: brand,
                        category: category,
                        imageUrl: imageUrl,
                        calories: calories ? Math.round(calories) : null,
                        proteins: proteins ? Math.round(proteins * 10) / 10 : null,
                        fats: fats ? Math.round(fats * 10) / 10 : null,
                        carbs: carbs ? Math.round(carbs * 10) / 10 : null,
                        barcode: barcode,
                        source: 'Open Food Facts',
                        weight: product.quantity || product.product_quantity || null
                    };
                }
                
                return { success: false };
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ Open Food Facts:', error);
                return { success: false };
            }
        }
        
        async function searchUPCitemdb(barcode) {
            try {
                const response = await fetch(`https://api.upcitemdb.com/prod/trial/lookup?upc=${barcode}`);
                const data = await response.json();
                
                if (data.code === 'OK' && data.items && data.items.length > 0) {
                    const item = data.items[0];
                    const productName = item.title || item.description || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç';
                    const brand = item.brand || '';
                    const imageUrl = item.images?.[0] || '';
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∫–∞–ª–æ—Ä–∏–∏ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è
                    let calories = null;
                    if (item.description) {
                        const calMatch = item.description.match(/(\d+)\s*(?:–∫–∞–ª|cal|kcal|calories)/i);
                        if (calMatch) {
                            calories = parseInt(calMatch[1]);
                        }
                    }
                    
                    return {
                        success: !!calories,
                        partial: !calories,
                        name: productName,
                        brand: brand,
                        imageUrl: imageUrl,
                        calories: calories,
                        barcode: barcode,
                        source: 'UPCitemdb',
                        message: calories ? null : '–ù–∞–π–¥–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ, –Ω–æ –ö–ë–ñ–£ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'
                    };
                }
                
                return { success: false };
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ UPCitemdb:', error);
                return { success: false };
            }
        }
        
        async function searchBarcodeLookup(barcode) {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π API (–º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
                const response = await fetch(`https://api.barcodelookup.com/v3/products?barcode=${barcode}`, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.products && data.products.length > 0) {
                        const product = data.products[0];
                        const productName = product.product_name || product.title || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç';
                        const brand = product.brand || '';
                        const imageUrl = product.images?.[0] || '';
                        
                        // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –æ –ø–∏—Ç–∞–Ω–∏–∏
                        const nutrition = product.nutrition || {};
                        const calories = nutrition.calories || null;
                        const proteins = nutrition.protein || null;
                        const fats = nutrition.fat || null;
                        const carbs = nutrition.carbohydrates || null;
                        
                        const hasNutrition = calories || proteins || fats || carbs;
                        
                        return {
                            success: hasNutrition,
                            partial: !hasNutrition,
                            name: productName,
                            brand: brand,
                            imageUrl: imageUrl,
                            calories: calories ? Math.round(calories) : null,
                            proteins: proteins ? Math.round(proteins * 10) / 10 : null,
                            fats: fats ? Math.round(fats * 10) / 10 : null,
                            carbs: carbs ? Math.round(carbs * 10) / 10 : null,
                            barcode: barcode,
                            source: 'Barcode Lookup',
                            message: hasNutrition ? null : '–ù–∞–π–¥–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ, –Ω–æ –ö–ë–ñ–£ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'
                        };
                    }
                }
                
                return { success: false };
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ Barcode Lookup:', error);
                return { success: false };
            }
        }

        function displayProduct(product) {
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            productImage.style.display = 'none';
            partialInfo.style.display = 'none';
            
            // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            productName.textContent = product.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç';
            productBrand.textContent = product.brand ? `üè∑ ${product.brand}` : '';
            productBarcode.textContent = `üìä –®—Ç—Ä–∏—Ö-–∫–æ–¥: ${product.barcode}`;
            productCategory.textContent = product.category ? `üìÅ ${product.category}` : '';
            
            // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (product.imageUrl) {
                productImage.src = product.imageUrl;
                productImage.style.display = 'block';
                productImage.onerror = () => {
                    productImage.style.display = 'none';
                };
            }
            
            // –ö–ë–ñ–£
            caloriesEl.textContent = product.calories ? `${product.calories} –∫–∫–∞–ª` : '-';
            proteinsEl.textContent = product.proteins !== null && product.proteins !== undefined ? `${product.proteins} –≥` : '-';
            fatsEl.textContent = product.fats !== null && product.fats !== undefined ? `${product.fats} –≥` : '-';
            carbsEl.textContent = product.carbs !== null && product.carbs !== undefined ? `${product.carbs} –≥` : '-';
            
            // –ò—Å—Ç–æ—á–Ω–∏–∫
            productSource.textContent = product.source ? `üì° –ò—Å—Ç–æ—á–Ω–∏–∫: ${product.source}` : '';
            
            // –í–µ—Å –ø—Ä–æ–¥—É–∫—Ç–∞
            if (product.weight) {
                const weightText = document.createElement('div');
                weightText.className = 'product-category';
                weightText.textContent = `‚öñÔ∏è –í–µ—Å: ${product.weight}`;
                if (!productCategory.textContent) {
                    productCategory.appendChild(weightText);
                }
            }
            
            // –ß–∞—Å—Ç–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            if (product.partial || product.message) {
                partialInfo.style.display = 'block';
                partialInfoText.textContent = product.message || '–ù–∞–π–¥–µ–Ω–∞ —á–∞—Å—Ç–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–¥—É–∫—Ç–µ';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –Ω–∞–∑–≤–∞–Ω–∏–µ
            addButton.style.display = product.name ? 'block' : 'none';
            
            productInfo.classList.add('active');
            status.classList.remove('active');
        }
        
        function displayPartialInfo(barcode, message) {
            productName.textContent = `–ü—Ä–æ–¥—É–∫—Ç —Å–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–º ${barcode}`;
            productBrand.textContent = '';
            productBarcode.textContent = `üìä –®—Ç—Ä–∏—Ö-–∫–æ–¥: ${barcode}`;
            productCategory.textContent = '';
            productImage.style.display = 'none';
            productSource.textContent = '';
            
            caloriesEl.textContent = '-';
            proteinsEl.textContent = '-';
            fatsEl.textContent = '-';
            carbsEl.textContent = '-';
            
            partialInfo.style.display = 'block';
            partialInfoText.textContent = message || '–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–∞—Ö –¥–∞–Ω–Ω—ã—Ö';
            
            addButton.style.display = 'block';
            addButton.textContent = '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥–æ–±–∞–≤–∏—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫';
            
            productInfo.classList.add('active');
            status.classList.remove('active');
        }
        
        async function handleManualBarcode(barcode) {
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            barcodeInput.value = '';
            currentBarcode = barcode;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
            status.classList.add('active', 'found');
            status.textContent = `üîç –ò—â—É –ø—Ä–æ–¥—É–∫—Ç –ø–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥—É: ${barcode}`;
            
            loading.classList.add('active');
            loading.querySelector('div:last-child').textContent = '–ò—â—É –ø—Ä–æ–¥—É–∫—Ç –≤ –±–∞–∑–∞—Ö –¥–∞–Ω–Ω—ã—Ö...';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            productInfo.classList.remove('active');
            
            try {
                const productData = await searchProductMultipleSources(barcode);
                
                if (productData && (productData.success || productData.partial)) {
                    displayProduct(productData);
                } else {
                    displayPartialInfo(barcode, '–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–∞—Ö –¥–∞–Ω–Ω—ã—Ö, –Ω–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω.');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø—Ä–æ–¥—É–∫—Ç–∞:', error);
                displayPartialInfo(barcode, `–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ: ${error.message}. –ù–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω.`);
            } finally {
                loading.classList.remove('active');
            }
        }

        function showError(message) {
            status.classList.add('active', 'error');
            status.textContent = message;
            setTimeout(() => {
                status.classList.remove('active', 'error');
            }, 3000);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞
        tg.onEvent('viewportChanged', () => {
            tg.expand();
        });
    </script>
</body>
</html>
