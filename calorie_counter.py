import sqlite3
import re
import os
import logging
import aiohttp
import json
import asyncio
from datetime import datetime, date, timedelta
from typing import Dict, List, Optional

logger = logging.getLogger(__name__)


def is_valid_product_name(name: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤–∞–ª–∏–¥–Ω—ã–º"""
    if not name or len(name.strip()) < 3:
        return False
    
    name_lower = name.lower().strip()
    
    # –°–ø–∏—Å–æ–∫ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π (—Å–ª—É–∂–µ–±–Ω—ã–µ —Å–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤)
    invalid_names = [
        'search', 'google', 'barcode', 'upc', 'product', 'item', 'not found',
        'error', '404', 'page', 'website', 'site', 'database', 'lookup',
        'results', 'query', 'find', 'search results', 'no results',
        'unknown', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π', '–Ω–µ –Ω–∞–π–¥–µ–Ω–æ', '–ø—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–¥–Ω–∏–º –∏–∑ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö
    if name_lower in invalid_names:
        return False
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Å–ª–æ–≤
    for invalid in invalid_names:
        if name_lower.startswith(invalid + ' ') or name_lower == invalid:
            return False
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –±—É–∫–≤—É (–Ω–µ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ —Å–∏–º–≤–æ–ª—ã)
    if not re.search(r'[–∞-—è—ëa-z]', name_lower, re.IGNORECASE):
        return False
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
    cleaned = re.sub(r'[^\w\s]', '', name_lower).strip()
    if len(cleaned) < 3:
        return False
    
    return True


class CalorieCounter:
    def __init__(self, db_path: str = "fitness_bot.db", groq_client=None):
        self.db_path = db_path
        self.groq_client = groq_client
        self.init_database()
    
    def get_connection(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö"""
        conn = sqlite3.connect(self.db_path)
        conn.row_factory = sqlite3.Row
        return conn
    
    def init_database(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–ª–æ—Ä–∏–π"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS meals (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                meal_name TEXT,
                calories INTEGER NOT NULL,
                date DATE NOT NULL,
                source TEXT,
                proteins REAL,
                fats REAL,
                carbs REAL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        for column in ['source', 'proteins', 'fats', 'carbs']:
            try:
                cursor.execute(f"ALTER TABLE meals ADD COLUMN {column} {'TEXT' if column == 'source' else 'REAL'}")
            except sqlite3.OperationalError:
                pass  # –ö–æ–ª–æ–Ω–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        
        # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –¥–Ω–µ–≤–Ω—ã—Ö –Ω–æ—Ä–º –∫–∞–ª–æ—Ä–∏–π
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS daily_limits (
                user_id INTEGER PRIMARY KEY,
                limit_calories INTEGER NOT NULL,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        
        # –ò–Ω–¥–µ–∫—Å—ã
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_meals_user_date ON meals(user_id, date)")
        
        conn.commit()
        conn.close()
    
    
    async def parse_with_groq(self, text: str) -> Optional[Dict]:
        """–ü–∞—Ä—Å–∏–Ω–≥ –∏ –ø–æ–¥—Å—á–µ—Ç –∫–∞–ª–æ—Ä–∏–π —Å –ø–æ–º–æ—â—å—é Groq"""
        if not self.groq_client:
            logger.debug("Groq –∫–ª–∏–µ–Ω—Ç –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–π –ø–∞—Ä—Å–∏–Ω–≥")
            return None
        
        try:
            logger.info(f"–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –≤ Groq –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞: {text}")
            prompt = (
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª –æ–ø–∏—Å–∞–Ω–∏–µ –µ–¥—ã: '{text}'\n\n"
                "–¢–´ –î–û–õ–ñ–ï–ù –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –¢–û–õ–¨–ö–û –†–ï–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï –ò–ó –ò–ù–¢–ï–†–ù–ï–¢–ê. –ù–ï –ü–†–ò–î–£–ú–´–í–ê–ô –ó–ù–ê–ß–ï–ù–ò–Ø!\n\n"
                "–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:\n"
                "1. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–†–§–û–ì–†–ê–§–ò–ß–ï–°–ö–ò–• –û–®–ò–ë–û–ö:\n"
                "   - –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä '–∫–æ—Ä–Ω–µ—à–æ–Ω' –≤–º–µ—Å—Ç–æ '–∫–æ—Ä–Ω–∏—à–æ–Ω', '–ø–µ–ª—å–º–µ–Ω' –≤–º–µ—Å—Ç–æ '–ø–µ–ª—å–º–µ–Ω–∏'), "
                "   –∏—Å–ø—Ä–∞–≤—å –∏—Ö –∏ –∏—â–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ü–†–ê–í–ò–õ–¨–ù–û –ù–ê–ü–ò–°–ê–ù–ù–û–ì–û –ø—Ä–æ–¥—É–∫—Ç–∞\n"
                "   - –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ –ø–æ–ª–µ 'name'\n"
                "   - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π: '–∫–æ—Ä–Ω–µ—à–æ–Ω' ‚Üí '–∫–æ—Ä–Ω–∏—à–æ–Ω', '–ø–µ–ª—å–º–µ–Ω' ‚Üí '–ø–µ–ª—å–º–µ–Ω–∏', '–≤–∞—Ä–µ–Ω–∏–∫' ‚Üí '–≤–∞—Ä–µ–Ω–∏–∫–∏'\n\n"
                "2. –ù–ï –†–ê–ó–ë–ò–í–ê–¢–¨ –ù–ê –ö–û–ú–ü–û–ù–ï–ù–¢–´ –ò –ü–†–ê–í–ò–õ–¨–ù–û–ï –ö–û–õ–ò–ß–ï–°–¢–í–û:\n"
                "   - –ï—Å–ª–∏ —ç—Ç–æ –ì–û–¢–û–í–û–ï –ë–õ–Æ–î–û –∏–∑ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞/—Ñ–∞—Å—Ç—Ñ—É–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä '—á–∏–∑–±—É—Ä–≥–µ—Ä –∏–∑ KFC', '—á–∏–∑–±—É—Ä–≥–µ—Ä –∏–∑ Burger King', '–±—É—Ä–≥–µ—Ä –∏–∑ –ú–∞–∫–¥–æ–Ω–∞–ª—å–¥—Å'), "
                "   –∏—â–∏ –ö–ë–ñ–£ –¥–ª—è –ì–û–¢–û–í–û–ì–û –ë–õ–Æ–î–ê —Ü–µ–ª–∏–∫–æ–º, –ù–ï —Ä–∞–∑–±–∏–≤–∞–π –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã!\n"
                "   - –ò—â–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –∏–ª–∏ –≤ –±–∞–∑–∞—Ö –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤—ã—Ö –±–ª—é–¥\n"
                "   - –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ï—Å–ª–∏ –≥–æ—Ç–æ–≤–æ–µ –±–ª—é–¥–æ —É–∫–∞–∑–∞–Ω–æ –∫–∞–∫ '1—à—Ç', '1 –ø–æ—Ä—Ü–∏—è', '1 –ø–æ—Ä—Ü' (–Ω–∞–ø—Ä–∏–º–µ—Ä '—á–∏–∑–±—É—Ä–≥–µ—Ä Burger King 1—à—Ç', '–ß–∏–∫–µ–Ω–ë—É—Ä–≥–µ—Ä 1 –ø–æ—Ä—Ü–∏—è', '—á–∏–∑–±—É—Ä–≥–µ—Ä –∏–∑ Rostics 1 –ø–æ—Ä—Ü–∏—è'), "
                "   –∏—â–∏ –ö–ë–ñ–£ –¥–ª—è –û–î–ù–û–ô –ü–û–†–¶–ò–ò –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞, –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –Ω–∞ 100–≥!\n"
                "   - –î–ª—è –≥–æ—Ç–æ–≤—ã—Ö –±–ª—é–¥ –∏–∑ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ '1—à—Ç', '1 –ø–æ—Ä—Ü–∏—è', '1 –ø–æ—Ä—Ü' –æ–∑–Ω–∞—á–∞—é—Ç –û–î–ù–£ –ü–û–†–¶–ò–Æ –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞, –∞ –Ω–µ 100–≥!\n"
                "   - –ü—Ä–∏–º–µ—Ä: —á–∏–∑–±—É—Ä–≥–µ—Ä Burger King 1—à—Ç = ~312-330 –∫–∫–∞–ª (–æ–¥–Ω–∞ –ø–æ—Ä—Ü–∏—è), –∞ –ù–ï 540 –∫–∫–∞–ª (—ç—Ç–æ –±—ã–ª–æ –±—ã –Ω–∞ 100–≥ –∏–ª–∏ –¥–≤–æ–π–Ω–æ–π —á–∏–∑–±—É—Ä–≥–µ—Ä)\n"
                "   - –ü—Ä–∏–º–µ—Ä: –ß–∏–∫–µ–Ω–ë—É—Ä–≥–µ—Ä McDonald's 1 –ø–æ—Ä—Ü–∏—è = ~350 –∫–∫–∞–ª (–æ–¥–Ω–∞ –ø–æ—Ä—Ü–∏—è), –∞ –ù–ï –¥–∞–Ω–Ω—ã–µ –Ω–∞ 100–≥!\n"
                "   - –ü—Ä–∏–º–µ—Ä: –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —á–∏–∑–±—É—Ä–≥–µ—Ä Rostics/–†–æ—Å—Ç–∏–∫'—Å 1—à—Ç = ~240 –∫–∫–∞–ª (–æ–¥–Ω–∞ –ø–æ—Ä—Ü–∏—è 130-140–≥), –∞ –ù–ï 400+ –∫–∫–∞–ª!\n"
                "   - –ü—Ä–∏–º–µ—Ä: –ß–∏–∫–µ–Ω–ë—É—Ä–≥–µ—Ä Rostics/–†–æ—Å—Ç–∏–∫'—Å 1—à—Ç = ~375 –∫–∫–∞–ª (–æ–¥–Ω–∞ –ø–æ—Ä—Ü–∏—è 135-150–≥), –∞ –ù–ï –¥–∞–Ω–Ω—ã–µ –Ω–∞ 100–≥!\n"
                "   - –ù–ï —Ä–∞–∑–±–∏–≤–∞–π –≥–æ—Ç–æ–≤—ã–µ –±–ª—é–¥–∞ –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (—Ö–ª–µ–±, —Å—ã—Ä, –º—è—Å–æ –æ—Ç–¥–µ–ª—å–Ω–æ) - –∏—â–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–æ—Ç–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞!\n"
                "   - –ù–ï —Ä–∞–∑–±–∏–≤–∞–π —Å–ª–æ–∂–Ω—ã–µ –±–ª—é–¥–∞ –Ω–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã, –µ—Å–ª–∏ —ç—Ç–æ –≥–æ—Ç–æ–≤–æ–µ –±–ª—é–¥–æ (–ø–∏—Ü—Ü–∞, —Ä–æ–ª–ª—ã, —Å—ç–Ω–¥–≤–∏—á–∏, —Å–∞–ª–∞—Ç—ã –∏–∑ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤)\n\n"
                "3. –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –°–¢–†–ê–ù–ù–´–• –ü–†–û–î–£–ö–¢–û–í:\n"
                "   - –ù–ï –¥–æ–±–∞–≤–ª—è–π –ø—Ä–æ–¥—É–∫—Ç—ã —Å –Ω—É–ª–µ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ö–ë–ñ–£ (0 –∫–∞–ª–æ—Ä–∏–π, 0 –±–µ–ª–∫–æ–≤, 0 –∂–∏—Ä–æ–≤, 0 —É–≥–ª–µ–≤–æ–¥–æ–≤)\n"
                "   - –ù–ï –¥–æ–±–∞–≤–ª—è–π –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–ª–∏ –≤—ã–¥—É–º–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã\n"
                "   - –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –Ω–∞–π—Ç–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ []\n\n"
                "–†–∞—Å–ø–æ–∑–Ω–∞–π –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏ –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. "
                "–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ –Ω–∞–π–¥–∏ –¢–û–ß–ù–´–ï –¥–∞–Ω–Ω—ã–µ –ö–ë–ñ–£ –∏–∑ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (USDA FoodData Central, Open Food Facts, –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∞–π—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π/—Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–∏—Ç–∞–Ω–∏—è).\n\n"
                "–í–ê–ñ–ù–û: –ï—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç —É–∫–∞–∑–∞–Ω –±–µ–∑ —è–≤–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä '–ø–µ–ª—å–º–µ–Ω–∏ 250–≥—Ä' –∏–ª–∏ '–ø–µ–ª—å–º–µ–Ω–∏ 250–≥'), "
                "—Ä–∞—Å–ø–æ–∑–Ω–∞–π –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞ (250–≥) –∏ –Ω–∞–π–¥–∏ –ö–ë–ñ–£ –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞. "
                "–ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ø–æ—Ä—Ü–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –ø–µ–ª—å–º–µ–Ω–µ–π - 100–≥ –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø–æ—Ä—Ü–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö).\n"
                "–î–ª—è –≥–æ—Ç–æ–≤—ã—Ö –±–ª—é–¥ –∏–∑ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ (–±—É—Ä–≥–µ—Ä—ã, –ø–∏—Ü—Ü–∞, —Ä–æ–ª–ª—ã –∏ —Ç.–¥.):\n"
                "- –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ '1—à—Ç', '1 –ø–æ—Ä—Ü–∏—è', '1 –ø–æ—Ä—Ü' - –∏—â–∏ –ö–ë–ñ–£ –¥–ª—è –û–î–ù–û–ô –ü–û–†–¶–ò–ò –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞ (–ù–ï –Ω–∞ 100–≥!)\n"
                "- '1 –ø–æ—Ä—Ü–∏—è' = '1—à—Ç' = –æ–¥–Ω–∞ –ø–æ—Ä—Ü–∏—è –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞, –ù–ï 100–≥!\n"
                "- –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –≥—Ä–∞–º–º–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä '–±—É—Ä–≥–µ—Ä 200–≥') - –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ\n"
                "- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –Ω–∞ 100–≥ –¥–ª—è –≥–æ—Ç–æ–≤—ã—Ö –±–ª—é–¥, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ '1—à—Ç' –∏–ª–∏ '1 –ø–æ—Ä—Ü–∏—è'!\n"
                "- –ò—â–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ì–û–¢–û–í–û–ì–û –ë–õ–Æ–î–ê, –Ω–µ —Ä–∞–∑–±–∏–≤–∞–π –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã!\n"
                "- –î–ª—è –±—É—Ä–≥–µ—Ä–æ–≤ –∏–∑ McDonald's, Burger King, KFC, Rostics –∏—â–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –û–î–ù–û–ô –ü–û–†–¶–ò–ò –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö!\n\n"
                "–í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –º–∞—Å—Å–∏–≤–∞, –≥–¥–µ –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç —ç—Ç–æ –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª—è–º–∏:\n"
                "- name: –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ (–Ω–∞ —Ä—É—Å—Å–∫–æ–º, —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞ –∏ –ø—Ä–æ–¥—É–∫—Ç–∞ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ)\n"
                "- amount: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—á–∏—Å–ª–æ, —Ç–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø–æ—Ä—Ü–∏—è)\n"
                "- unit: –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è ('–≥', '–º–ª', '—à—Ç', '–∫–≥', '–ª')\n"
                "- calories: –∫–∞–ª–æ—Ä–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (—á–∏—Å–ª–æ, –¢–û–ß–ù–û–ï –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)\n"
                "- proteins: –±–µ–ª–∫–∏ –≤ –≥—Ä–∞–º–º–∞—Ö –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (—á–∏—Å–ª–æ, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û, —Ç–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)\n"
                "- fats: –∂–∏—Ä—ã –≤ –≥—Ä–∞–º–º–∞—Ö –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (—á–∏—Å–ª–æ, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û, —Ç–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)\n"
                "- carbs: —É–≥–ª–µ–≤–æ–¥—ã –≤ –≥—Ä–∞–º–º–∞—Ö –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (—á–∏—Å–ª–æ, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û, —Ç–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)\n"
                "- source: –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä 'USDA FoodData Central', 'Open Food Facts', '–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è')\n\n"
                "–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:\n"
                "- –ù–ï –ü–†–ò–î–£–ú–´–í–ê–ô –¥–∞–Ω–Ω—ã–µ! –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞\n"
                "- –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –Ω–∞–π—Ç–∏ —Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞, –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ []\n"
                "- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∑—ã–≤–∞–π –í–°–ï —Ç—Ä–∏ –∑–Ω–∞—á–µ–Ω–∏—è: proteins, fats, carbs\n"
                "- –ï—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç —É–∫–∞–∑–∞–Ω –±–µ–∑ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä '–∫–æ–Ω—Ñ–µ—Ç—É Raffaelo'), –Ω–∞–π–¥–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–µ—Å –æ–¥–Ω–æ–π —à—Ç—É–∫–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ\n"
                "- –£–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö (–Ω–µ –ø—Ä–æ—Å—Ç–æ '–ò–Ω—Ç–µ—Ä–Ω–µ—Ç', –∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)\n"
                "- –ó–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–Ω—Ñ–µ—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å 500 –∫–∫–∞–ª –Ω–∞ 1—à—Ç)\n"
                "- –î–ª—è –≥–æ—Ç–æ–≤—ã—Ö –±–ª—é–¥ –∏–∑ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å:\n"
                "  * –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —á–∏–∑–±—É—Ä–≥–µ—Ä Burger King ~312-330 –∫–∫–∞–ª –Ω–∞ 1—à—Ç (–ù–ï 540 –∫–∫–∞–ª!)\n"
                "  * –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —á–∏–∑–±—É—Ä–≥–µ—Ä Rostics/–†–æ—Å—Ç–∏–∫'—Å ~240 –∫–∫–∞–ª –Ω–∞ 1—à—Ç (–ù–ï 400+ –∫–∫–∞–ª!)\n"
                "  * –ß–∏–∫–µ–Ω–ë—É—Ä–≥–µ—Ä Rostics/–†–æ—Å—Ç–∏–∫'—Å ~375 –∫–∫–∞–ª –Ω–∞ 1—à—Ç (–ù–ï 500+ –∫–∫–∞–ª!)\n"
                "  * –ß–∏–∫–µ–Ω–ë—É—Ä–≥–µ—Ä McDonald's ~350 –∫–∫–∞–ª –Ω–∞ 1—à—Ç (–ù–ï 500+ –∫–∫–∞–ª!)\n"
                "- –ï—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏—à—å –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –∫–∞–∂—É—Ç—Å—è —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–º–∏ –¥–ª—è '1—à—Ç' –∏–ª–∏ '1 –ø–æ—Ä—Ü–∏—è' –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞, –ø—Ä–æ–≤–µ—Ä—å - –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–∞ 100–≥ –∏–ª–∏ –¥–≤–æ–π–Ω–∞—è –ø–æ—Ä—Ü–∏—è!\n"
                "- –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ö–æ–≥–¥–∞ –∏—â–µ—à—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º '1—à—Ç' –∏–ª–∏ '1 –ø–æ—Ä—Ü–∏—è', –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –Ω–∞ 100–≥!\n"
                "- –ò—â–∏ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –û–î–ù–û–ô –ü–û–†–¶–ò–ò –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞!\n"
                "- –î–ª—è Rostics/–†–æ—Å—Ç–∏–∫'—Å: –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —á–∏–∑–±—É—Ä–≥–µ—Ä = ~240 –∫–∫–∞–ª, –ß–∏–∫–µ–Ω–ë—É—Ä–≥–µ—Ä = ~375 –∫–∫–∞–ª!\n"
                "- –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –û–î–ù–û–ô –ü–û–†–¶–ò–ò:\n"
                "  * –ß–∏–∫–µ–Ω–ë—É—Ä–≥–µ—Ä McDonald's 1—à—Ç = ~350 –∫–∫–∞–ª (–ù–ï 500+ –∫–∫–∞–ª!)\n"
                "  * –ß–∏–∑–±—É—Ä–≥–µ—Ä Burger King 1—à—Ç = ~312 –∫–∫–∞–ª (–ù–ï 500+ –∫–∫–∞–ª!)\n"
                "  * –ß–∏–∑–±—É—Ä–≥–µ—Ä Rostics/–†–æ—Å—Ç–∏–∫'—Å 1—à—Ç = ~240 –∫–∫–∞–ª (–ù–ï 400+ –∫–∫–∞–ª! –≠—Ç–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —á–∏–∑–±—É—Ä–≥–µ—Ä)\n"
                "  * –ß–∏–∫–µ–Ω–ë—É—Ä–≥–µ—Ä Rostics/–†–æ—Å—Ç–∏–∫'—Å 1—à—Ç = ~375 –∫–∫–∞–ª (–ù–ï 500+ –∫–∫–∞–ª!)\n"
                "  * –ß–∏–∑–±—É—Ä–≥–µ—Ä –î–µ –õ—é–∫—Å Rostics = ~350+ –∫–∫–∞–ª (—ç—Ç–æ –¥—Ä—É–≥–æ–π –±—É—Ä–≥–µ—Ä, –Ω–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π!)\n\n"
                "–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:\n"
                '–î–ª—è "–æ–≤—Å—è–Ω–∫–∞ 200–≥": [{"name": "–æ–≤—Å—è–Ω–∫–∞", "amount": 200, "unit": "–≥", "calories": 778, "proteins": 26, "fats": 14, "carbs": 138, "source": "USDA FoodData Central"}]\n'
                '–î–ª—è "–∫–æ–Ω—Ñ–µ—Ç—É Raffaelo": [{"name": "Raffaello", "amount": 1, "unit": "—à—Ç", "calories": 61, "proteins": 1.1, "fats": 4.5, "carbs": 4.8, "source": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç Ferrero"}]\n'
                '–î–ª—è "–ø–µ–ª—å–º–µ–Ω–∏ 250–≥—Ä" –∏–ª–∏ "–ø–µ–ª—å–º–µ–Ω–∏ 250–≥": [{"name": "–ø–µ–ª—å–º–µ–Ω–∏", "amount": 250, "unit": "–≥", "calories": 625, "proteins": 25, "fats": 20, "carbs": 75, "source": "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–∏—Ç–∞–Ω–∏—è / USDA FoodData Central"}]\n'
                '–î–ª—è "–ø–µ–ª—å–º–µ–Ω–∏" (–±–µ–∑ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞): [{"name": "–ø–µ–ª—å–º–µ–Ω–∏", "amount": 100, "unit": "–≥", "calories": 250, "proteins": 10, "fats": 8, "carbs": 30, "source": "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–∏—Ç–∞–Ω–∏—è"}]\n'
                '–î–ª—è "–∫–æ—Ä–Ω–∏—à–æ–Ω 5—à—Ç" –∏–ª–∏ "–∫–æ—Ä–Ω–∏—à–æ–Ω 5 —à—Ç": [{"name": "–∫–æ—Ä–Ω–∏—à–æ–Ω", "amount": 5, "unit": "—à—Ç", "calories": 5, "proteins": 0.3, "fats": 0.1, "carbs": 1, "source": "USDA FoodData Central"}]\n'
                '–î–ª—è "–∫–æ—Ä–Ω–µ—à–æ–Ω 5—à—Ç" (—Å –æ—à–∏–±–∫–æ–π): [{"name": "–∫–æ—Ä–Ω–∏—à–æ–Ω", "amount": 5, "unit": "—à—Ç", "calories": 5, "proteins": 0.3, "fats": 0.1, "carbs": 1, "source": "USDA FoodData Central"}]\n'
                '   (–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ "–∫–æ—Ä–Ω–µ—à–æ–Ω" ‚Üí "–∫–æ—Ä–Ω–∏—à–æ–Ω")\n'
                '–î–ª—è "—á–∏–∑–±—É—Ä–≥–µ—Ä –∏–∑ KFC 1—à—Ç": [{"name": "—á–∏–∑–±—É—Ä–≥–µ—Ä KFC", "amount": 1, "unit": "—à—Ç", "calories": 540, "proteins": 30, "fats": 30, "carbs": 40, "source": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç KFC"}]\n'
                '–î–ª—è "—á–∏–∑–±—É—Ä–≥–µ—Ä Burger King 1—à—Ç": [{"name": "—á–∏–∑–±—É—Ä–≥–µ—Ä Burger King", "amount": 1, "unit": "—à—Ç", "calories": 312, "proteins": 16, "fats": 12, "carbs": 27, "source": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç Burger King"}]\n'
                '–î–ª—è "–ß–∏–∫–µ–Ω–ë—É—Ä–≥–µ—Ä 1 –ø–æ—Ä—Ü–∏—è": [{"name": "–ß–∏–∫–µ–Ω–ë—É—Ä–≥–µ—Ä McDonald\'s", "amount": 1, "unit": "—à—Ç", "calories": 350, "proteins": 25, "fats": 15, "carbs": 30, "source": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç McDonald\'s"}]\n'
                '–î–ª—è "—á–∏–∑–±—É—Ä–≥–µ—Ä –∏–∑ Rostics 1 –ø–æ—Ä—Ü–∏—è": [{"name": "—á–∏–∑–±—É—Ä–≥–µ—Ä Rostics", "amount": 1, "unit": "—à—Ç", "calories": 240, "proteins": 12.5, "fats": 9, "carbs": 26, "source": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç Rostics"}]\n'
                '–î–ª—è "—á–∏–∑–±—É—Ä–≥–µ—Ä –∏–∑ –†–æ—Å—Ç–∏–∫\'—Å 1 –ø–æ—Ä—Ü–∏—è": [{"name": "—á–∏–∑–±—É—Ä–≥–µ—Ä –†–æ—Å—Ç–∏–∫\'—Å", "amount": 1, "unit": "—à—Ç", "calories": 240, "proteins": 12.5, "fats": 9, "carbs": 26, "source": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç –†–æ—Å—Ç–∏–∫\'—Å"}]\n'
                '–î–ª—è "–ß–∏–∫–µ–Ω–ë—É—Ä–≥–µ—Ä –∏–∑ Rostics 1 –ø–æ—Ä—Ü–∏—è": [{"name": "–ß–∏–∫–µ–Ω–ë—É—Ä–≥–µ—Ä Rostics", "amount": 1, "unit": "—à—Ç", "calories": 375, "proteins": 16.5, "fats": 14.5, "carbs": 39, "source": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç Rostics"}]\n'
                '–î–ª—è "–ß–∏–∫–µ–Ω–ë—É—Ä–≥–µ—Ä –∏–∑ –†–æ—Å—Ç–∏–∫\'—Å 1 –ø–æ—Ä—Ü–∏—è": [{"name": "–ß–∏–∫–µ–Ω–ë—É—Ä–≥–µ—Ä –†–æ—Å—Ç–∏–∫\'—Å", "amount": 1, "unit": "—à—Ç", "calories": 375, "proteins": 16.5, "fats": 14.5, "carbs": 39, "source": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç –†–æ—Å—Ç–∏–∫\'—Å"}]\n'
                '   (–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ: —ç—Ç–æ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –û–î–ù–û–ô –ü–û–†–¶–ò–ò –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞, –ù–ï –Ω–∞ 100–≥! "1 –ø–æ—Ä—Ü–∏—è" = "1—à—Ç" = –æ–¥–Ω–∞ –ø–æ—Ä—Ü–∏—è!)\n'
                '–î–ª—è "—á–∏–∑–±—É—Ä–≥–µ—Ä –∏–∑ Rostiks 1—à—Ç": [{"name": "—á–∏–∑–±—É—Ä–≥–µ—Ä Rostiks", "amount": 1, "unit": "—à—Ç", "calories": 450, "proteins": 25, "fats": 22, "carbs": 38, "source": "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤—ã—Ö –±–ª—é–¥ / –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç Rostiks"}]\n'
                '   (–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ: –ù–ï —Ä–∞–∑–±–∏–≤–∞–π –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã! –ò—â–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞ —Ü–µ–ª–∏–∫–æ–º! –î–ª—è "1—à—Ç" –∏–ª–∏ "1 –ø–æ—Ä—Ü–∏—è" - –¥–∞–Ω–Ω—ã–µ –¥–ª—è –û–î–ù–û–ô –ü–û–†–¶–ò–ò, –∞ –Ω–µ –Ω–∞ 100–≥!)\n\n'
                "–í–ê–ñ–ù–û:\n"
                "- –ò—Å–ø—Ä–∞–≤–ª—è–π –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤\n"
                "- –î–ª—è –≥–æ—Ç–æ–≤—ã—Ö –±–ª—é–¥ –∏–∑ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –ù–ï —Ä–∞–∑–±–∏–≤–∞–π –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã! –ò—â–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞ —Ü–µ–ª–∏–∫–æ–º!\n"
                "- –ù–ï –¥–æ–±–∞–≤–ª—è–π –ø—Ä–æ–¥—É–∫—Ç—ã —Å –Ω—É–ª–µ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ö–ë–ñ–£\n\n"
                "–ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –Ω–∞–π—Ç–∏ —Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ []. "
                "–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¢–û–õ–¨–ö–û JSON –º–∞—Å—Å–∏–≤–æ–º, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."
            )
            
            # –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –º–æ—â–Ω—É—é –º–æ–¥–µ–ª—å, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
            # llama-3.3-70b-versatile - –±–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è –º–æ–¥–µ–ª—å (70B –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)
            # llama-3.1-70b-versatile - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞
            # llama-3.1-8b-instant - –±—ã—Å—Ç—Ä–∞—è, –Ω–æ –º–µ–Ω–µ–µ —Ç–æ—á–Ω–∞—è (fallback)
            models_to_try = [
                "llama-3.3-70b-versatile",  # –°–∞–º–∞—è –º–æ—â–Ω–∞—è –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å Groq
                "llama-3.1-70b-versatile",  # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞
                "llama-3.1-8b-instant"       # Fallback –Ω–∞ –±—ã—Å—Ç—Ä—É—é –º–æ–¥–µ–ª—å
            ]
            
            response = None
            last_error = None
            
            for model_name in models_to_try:
                try:
                    logger.info(f"–ü—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª—å: {model_name}")
                    response = self.groq_client.chat.completions.create(
                        model=model_name,
                        messages=[
                            {"role": "system", "content": "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∫–∞–ª–æ—Ä–∏–π. –¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –¢–û–õ–¨–ö–û —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ (USDA, Open Food Facts, –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∞–π—Ç—ã). –ù–ï –ü–†–ò–î–£–ú–´–í–ê–ô –∑–Ω–∞—á–µ–Ω–∏—è! –ò—Å–ø—Ä–∞–≤–ª—è–π –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤. –î–ª—è –≥–æ—Ç–æ–≤—ã—Ö –±–ª—é–¥ –∏–∑ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –ù–ï —Ä–∞–∑–±–∏–≤–∞–π –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã - –∏—â–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞ —Ü–µ–ª–∏–∫–æ–º. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ï—Å–ª–∏ –≥–æ—Ç–æ–≤–æ–µ –±–ª—é–¥–æ —É–∫–∞–∑–∞–Ω–æ –∫–∞–∫ '1—à—Ç', '1 –ø–æ—Ä—Ü–∏—è' –∏–ª–∏ '1 –ø–æ—Ä—Ü' - –∏—â–∏ –ö–ë–ñ–£ –¥–ª—è –û–î–ù–û–ô –ü–û–†–¶–ò–ò –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞, –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –Ω–∞ 100–≥! '1 –ø–æ—Ä—Ü–∏—è' = '1—à—Ç' = –æ–¥–Ω–∞ –ø–æ—Ä—Ü–∏—è –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞! –ù–ï –¥–æ–±–∞–≤–ª—è–π –ø—Ä–æ–¥—É–∫—Ç—ã —Å –Ω—É–ª–µ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ö–ë–ñ–£. –ü—Ä–æ–≤–µ—Ä—è–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö. –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –Ω–∞–π—Ç–∏ —Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ []. –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ—à—å —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–º JSON –º–∞—Å—Å–∏–≤–æ–º –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."},
                            {"role": "user", "content": prompt}
                        ],
                        temperature=0.1,  # –°–Ω–∏–∂–∞–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                        max_tokens=800  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                    )
                    logger.info(f"–£—Å–ø–µ—à–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –º–æ–¥–µ–ª—å: {model_name}")
                    break  # –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç–≤–µ—Ç
                except Exception as e:
                    logger.warning(f"–ú–æ–¥–µ–ª—å {model_name} –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: {e}")
                    last_error = e
                    continue  # –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â—É—é –º–æ–¥–µ–ª—å
            
            if not response:
                raise Exception(f"–í—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {last_error}")
            
            logger.info(f"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Groq: {response.choices[0].message.content[:200]}")
            
            import json
            result_text = response.choices[0].message.content.strip()
            
            # –£–±–∏—Ä–∞–µ–º markdown –∫–æ–¥ –±–ª–æ–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            if result_text.startswith('```'):
                lines = result_text.split('\n')
                result_text = '\n'.join(lines[1:-1]) if len(lines) > 2 else result_text
            
            # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            try:
                parsed = json.loads(result_text)
                # –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç —Å –º–∞—Å—Å–∏–≤–æ–º –≤–Ω—É—Ç—Ä–∏
                if isinstance(parsed, dict):
                    # –ò—â–µ–º –º–∞—Å—Å–∏–≤ –≤ –∑–Ω–∞—á–µ–Ω–∏—è—Ö
                    items = None
                    for key, value in parsed.items():
                        if isinstance(value, list):
                            items = value
                            break
                    # –ò–ª–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–ª—é—á "items" –∏–ª–∏ "products"
                    if not items:
                        items = parsed.get('items') or parsed.get('products') or parsed.get('food')
                    if not items:
                        return None
                elif isinstance(parsed, list):
                    items = parsed
                else:
                    return None
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                if not items or not isinstance(items, list) or len(items) == 0:
                    logger.warning("Groq –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")
                    return None
                
                # –í–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
                valid_items = []
                sources = []
                for item in items:
                    if isinstance(item, dict) and 'name' in item:
                        product_name = item.get('name', '').lower()
                        
                        # –§–∏–ª—å—Ç—Ä—É–µ–º —è–≤–Ω–æ –Ω–µ-–µ–¥—É
                        invalid_words = ['–∫–∞–∫–∞—à', '–ø–∏—Å—å–∫', '–≥–æ–≤–Ω', '–¥–µ—Ä—å–º', '—Ö—É–π', '–ø–∏–∑–¥', '–µ–±–∞–Ω', '–±–ª—è–¥']
                        if any(word in product_name for word in invalid_words):
                            logger.warning(f"–ü—Ä–æ–ø—É—â–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç: {item.get('name')}")
                            continue
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –∫–∞–ª–æ—Ä–∏–∏
                        calories = item.get('calories', 0)
                        proteins = item.get('proteins', 0)
                        fats = item.get('fats', 0)
                        carbs = item.get('carbs', 0)
                        
                        # –ï—Å–ª–∏ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω—É–ª–∏ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (—ç—Ç–æ –Ω–µ —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç)
                        if calories == 0 and proteins == 0 and fats == 0 and carbs == 0:
                            logger.warning(f"–ü—Ä–æ–ø—É—â–µ–Ω –ø—Ä–æ–¥—É–∫—Ç —Å –Ω—É–ª–µ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏: {item.get('name')}")
                            continue
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
                        # –ï—Å–ª–∏ –∫–∞–ª–æ—Ä–∏–∏ –µ—Å—Ç—å, –Ω–æ –ö–ë–ñ–£ –≤—Å–µ –Ω—É–ª–∏ - –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ
                        if calories > 0 and proteins == 0 and fats == 0 and carbs == 0:
                            logger.warning(f"–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Groq –¥–ª—è {item.get('name')}: –∫–∞–ª–æ—Ä–∏–∏ –µ—Å—Ç—å, –Ω–æ –ö–ë–ñ–£ –≤—Å–µ –Ω—É–ª–∏")
                            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç –ø—Ä–æ–¥—É–∫—Ç –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                            continue
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã
                        if calories > 0:
                            # –ü—Ä–∏–º–µ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –∫–∞–ª–æ—Ä–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ = –±–µ–ª–∫–∏*4 + –∂–∏—Ä—ã*9 + —É–≥–ª–µ–≤–æ–¥—ã*4
                            estimated_calories = proteins * 4 + fats * 9 + carbs * 4
                            if abs(calories - estimated_calories) > calories * 0.3:  # –†–∞–∑–Ω–∏—Ü–∞ –Ω–µ –±–æ–ª–µ–µ 30%
                                logger.warning(f"–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–∞–ª–æ—Ä–∏–π –∏ –ö–ë–ñ–£ –¥–ª—è {item.get('name')}: –∫–∞–ª–æ—Ä–∏–∏={calories}, —Ä–∞—Å—á–µ—Ç–Ω—ã–µ={estimated_calories}")
                        
                        valid_items.append({
                            'name': item.get('name', ''),
                            'amount': item.get('amount', 0),
                            'unit': item.get('unit', '–≥'),
                            'calories': calories,
                            'proteins': proteins,
                            'fats': fats,
                            'carbs': carbs,
                            'source': item.get('source', 'Groq AI')
                        })
                        if item.get('source'):
                            sources.append(item.get('source'))
                
                # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
                if not valid_items:
                    logger.warning("–ü–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –æ—Ç Groq")
                    return None
                
                total_calories = sum(item.get('calories', 0) for item in valid_items)
                total_proteins = sum(item.get('proteins', 0) for item in valid_items)
                total_fats = sum(item.get('fats', 0) for item in valid_items)
                total_carbs = sum(item.get('carbs', 0) for item in valid_items)
                meal_name = ', '.join([f"{item['name']} {item['amount']}{item['unit']}" for item in valid_items])
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ (–µ—Å–ª–∏ –≤—Å–µ –∏–∑ –æ–¥–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ "Groq AI")
                unique_sources = list(set(sources))
                if len(unique_sources) == 1:
                    source = unique_sources[0]
                elif len(unique_sources) > 1:
                    source = f"Groq AI ({', '.join(unique_sources)})"
                else:
                    source = "Groq AI"
                
                return {
                    'success': True,
                    'items': valid_items,
                    'calories': int(total_calories),
                    'meal_name': meal_name,
                    'proteins': round(total_proteins, 1) if total_proteins > 0 else None,
                    'fats': round(total_fats, 1) if total_fats > 0 else None,
                    'carbs': round(total_carbs, 1) if total_carbs > 0 else None,
                    'source': source
                }
            except json.JSONDecodeError as e:
                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç Groq: {result_text[:200]}... –û—à–∏–±–∫–∞: {e}")
                logger.error(f"–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç Groq: {result_text}")
                return None
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Groq –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –µ–¥—ã: {e}", exc_info=True)
            return None
    
    async def is_food_related(self, text: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç –∫ –µ–¥–µ"""
        text_lower = text.lower().strip()
        
        # –°–ø–∏—Å–æ–∫ —è–≤–Ω–æ –Ω–µ-–µ–¥—ã (–±—Ä–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞, –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è, –Ω–µ—Ü–µ–Ω–∑—É—Ä–Ω—ã–µ —Å–ª–æ–≤–∞)
        invalid_words = ['–∫–∞–∫–∞—à', '–ø–∏—Å—å–∫', '–≥–æ–≤–Ω', '–¥–µ—Ä—å–º', '—Ö—É–π', '–ø–∏–∑–¥', '–µ–±–∞–Ω', '–±–ª—è–¥', '—Å—É–∫–∞', 
                        '–º—É–¥–∞–∫', '–¥–æ–ª–±–æ–µ–±', '–∏–¥–∏–æ—Ç', '–¥—É—Ä–∞–∫', '–ª–æ—Ö', '–ª–æ—à–∞—Ä', '–∫—Ä–µ—Ç–∏–Ω', '–¥–µ–±–∏–ª']
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —è–≤–Ω–æ –Ω–µ-–µ–¥—É
        if any(word in text_lower for word in invalid_words):
            logger.info(f"–¢–µ–∫—Å—Ç '{text}' —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—Ü–µ–Ω–∑—É—Ä–Ω—ã–µ/–Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Å–ª–æ–≤–∞")
            return False
        
        # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–∏—Ç–∞–Ω–∏—è
        food_keywords = [
            '–≥', '–∫–≥', '–º–ª', '–ª', '—à—Ç', '—à—Ç—É–∫', '—à—Ç—É–∫–∏', '–∫–∞–ª–æ—Ä–∏', '–∫–∫–∞–ª', '–µ–¥–∞', '—Å—ä–µ–ª', '—Å—ä–µ–ª–∞',
            '–∑–∞–≤—Ç—Ä–∞–∫', '–æ–±–µ–¥', '—É–∂–∏–Ω', '–ø–æ–µ–ª', '–ø–æ–µ–ª–∞', '–∫–æ–Ω—Ñ–µ—Ç', '–ø–µ–ª—å–º–µ–Ω', '–≤–∞—Ä–µ–Ω–∏–∫', '–±–ª–∏–Ω',
            '—Ö–ª–µ–±', '–º—è—Å–æ', '—Ä—ã–±–∞', '–æ–≤–æ—â', '—Ñ—Ä—É–∫—Ç', '–º–æ–ª–æ–∫–æ', '—Å—ã—Ä', '–π–æ–≥—É—Ä—Ç', '–∫–µ—Ñ–∏—Ä', '—Ç–≤–æ—Ä–æ–≥',
            '–æ–≤—Å—è–Ω–∫', '–≥—Ä–µ—á–∫', '—Ä–∏—Å', '–º–∞–∫–∞—Ä–æ–Ω', '–∫–∞—Ä—Ç–æ—à–∫', '–ø–æ–º–∏–¥–æ—Ä', '–æ–≥—É—Ä—Ü', '–º–æ—Ä–∫–æ–≤', '–∫–∞–ø—É—Å—Ç',
            '—è–±–ª–æ–∫', '–±–∞–Ω–∞–Ω', '–∞–ø–µ–ª—å—Å–∏–Ω', '–º–∞–Ω–¥–∞—Ä–∏–Ω', '–±–æ—Ä—â', '—Å—É–ø', '—Å–∞–ª–∞—Ç', '–∫—É—Ä–∏—Ü', '—è–π—Ü',
            '—Å–º–µ—Ç–∞–Ω', '–º–∞–π–æ–Ω–µ–∑', '–º–∞—Å–ª–æ', '—Å–∞—Ö–∞—Ä', '—Å–æ–ª—å', '—Å–æ—É—Å', '–∫–µ—Ç—á—É–ø', '–≥–æ—Ä—á–∏—Ü',
            '–∫–æ–ª–±–∞—Å', '—Å–æ—Å–∏—Å–∫', '–≤–µ—Ç—á–∏–Ω', '–±–µ–∫–æ–Ω', '—Å–≤–∏–Ω–∏–Ω', '–≥–æ–≤—è–¥–∏–Ω', '–±–∞—Ä–∞–Ω', '–∏–Ω–¥–µ–π–∫',
            '–ª–æ—Å–æ—Å', '—Ç—É–Ω–µ—Ü', '—Å–µ–ª–µ–¥–∫', '–∏–∫—Ä', '–∫—Ä–µ–≤–µ—Ç–∫', '–∫–∞–ª—å–º–∞—Ä', '–º–∏–¥–∏', '–∫—Ä–∞–±',
            '—Å–ª–∏–≤–∫', '–º–∞—Ä–≥–∞—Ä–∏–Ω', '—Å–ø—Ä–µ–¥', '–±—Ä—ã–Ω–∑', '—Ñ–µ—Ç', '—Ä—è–∂–µ–Ω–∫', '–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à', '–≤–∞—Ä–µ–Ω–µ—Ü',
            '–±–∞—Ç–æ–Ω', '–±—É–ª–∫', '–±—É—Ç–µ—Ä–±—Ä–æ–¥', '—Ç–æ—Å—Ç', '—Å—É—Ö–∞—Ä', '–≥—Ä–µ–Ω–∫', '–∫—Ä—É–∞—Å—Å–∞–Ω',
            '–ø–µ—á–µ–Ω—å', '—Ç–æ—Ä—Ç', '–ø–∏—Ä–æ–∂–Ω', '—à–æ–∫–æ–ª–∞–¥', '–≤–∞—Ñ–µ–ª', '–∫–µ–∫—Å', '–º–∞—Ñ—Ñ–∏–Ω',
            '–º–æ—Ä–æ–∂–µ–Ω', '–∂–µ–ª–µ', '–ø—É–¥–∏–Ω–≥', '–º—É—Å—Å', '–∫—Ä–µ–º', '–±–µ–∑–µ', '–∑–µ—Ñ–∏—Ä', '–º–∞—Ä–º–µ–ª–∞–¥', '—Ö–∞–ª–≤',
            '–æ—Ä–µ—Ö', '–º–∏–Ω–¥–∞–ª', '—Ñ—É–Ω–¥—É–∫', '–≥—Ä–µ—Ü–∫', '–∫–µ—à—å—é', '—Ñ–∏—Å—Ç–∞—à–∫', '–∞—Ä–∞—Ö–∏—Å', '—Å–µ–º–µ—á–∫', '–∫—É–Ω–∂—É—Ç',
            '–∏–∑—é–º', '–∫—É—Ä–∞–≥', '—á–µ—Ä–Ω–æ—Å–ª–∏–≤', '—Ñ–∏–Ω–∏–∫', '–∏–Ω–∂–∏—Ä', '–∫–ª—é–∫–≤', '–±—Ä—É—Å–Ω–∏–∫', '–æ–±–ª–µ–ø–∏—Ö',
            '—á–∞–π', '–∫–æ—Ñ–µ', '–∫–∞–∫–∞–æ', '—Å–æ–∫', '–∫–æ–º–ø–æ—Ç', '–º–æ—Ä—Å', '–∫–∏—Å–µ–ª', '–ª–∏–º–æ–Ω–∞–¥', '–≥–∞–∑–∏—Ä–æ–≤–∫',
            '–ø–∏–≤–æ', '–≤–∏–Ω–æ', '–≤–æ–¥–∫', '–∫–æ–Ω—å—è–∫', '–≤–∏—Å–∫–∏', '—Ä–æ–º', '–¥–∂–∏–Ω', '–ª–∏–∫–µ—Ä', '—à–∞–º–ø–∞–Ω—Å–∫',
            '–≤–æ–¥', '–º–∏–Ω–µ—Ä–∞–ª–∫', '—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫', '—Å–ø–æ—Ä—Ç–ø–∏—Ç', '–ø—Ä–æ—Ç–µ–∏–Ω', '–≥–µ–π–Ω–µ—Ä', '–∫—Ä–µ–∞—Ç–∏–Ω',
            '–±–∞—Ç–æ–Ω—á–∏–∫', '–ø–µ—á–µ–Ω—å–µ', '–∫–∞—à–∞', '—Ä–æ—Å—Ç–∞–≥—Ä–æ—ç–∫—Å–ø–æ—Ä—Ç', '—Ä–æ—Å—Ç–∏–∫', '–º–∞–∫–¥–æ–Ω–∞–ª—å–¥—Å', 'burger king',
            'kfc', '—á–∏–∑–±—É—Ä–≥–µ—Ä', '–±—É—Ä–≥–µ—Ä', '—á–∏–∫–µ–Ω–±—É—Ä–≥–µ—Ä', '—á–∏–∫–µ–Ω –±—É—Ä–≥–µ—Ä'
        ]
        
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —è–≤–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –µ–¥—ã (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ)
        has_food_keyword = any(keyword in text_lower for keyword in food_keywords)
        has_number_with_unit = bool(re.search(r'\d+\s*(–≥|–∫–≥|–º–ª|–ª|—à—Ç|—à—Ç—É–∫|—à—Ç—É–∫–∏|–≥—Ä–∞–º–º|–≥—Ä–∞–º–º–æ–≤|–∫–∏–ª–æ–≥—Ä–∞–º–º|–∫–∏–ª–æ–≥—Ä–∞–º–º–æ–≤|–º–∏–ª–ª–∏–ª–∏—Ç—Ä|–ª–∏—Ç—Ä)', text_lower))
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å —è–≤–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –µ–¥—ã - —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º True
        if has_food_keyword or has_number_with_unit:
            logger.info(f"–¢–µ–∫—Å—Ç '{text}' —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ –µ–¥–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º/–µ–¥–∏–Ω–∏—Ü–∞–º –∏–∑–º–µ—Ä–µ–Ω–∏—è")
            return True
        
        # –ï—Å–ª–∏ Groq –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
        if not self.groq_client:
            return has_food_keyword or has_number_with_unit
        
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º Groq –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
            prompt = (
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª: '{text}'\n\n"
                "–û–ø—Ä–µ–¥–µ–ª–∏, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫ –†–ï–ê–õ–¨–ù–û–ô –µ–¥–µ/–ø—Ä–æ–¥—É–∫—Ç–∞–º –ø–∏—Ç–∞–Ω–∏—è. "
                "–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û 'yes' –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ –†–ï–ê–õ–¨–ù–£–Æ –µ–¥—É, –∏–ª–∏ 'no' –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø—Ä–æ –µ–¥—É.\n\n"
                "–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ –µ–¥—É: '–ø–µ–ª—å–º–µ–Ω–∏ 250–≥', '—Å—ä–µ–ª —è–±–ª–æ–∫–æ', '–æ–≤—Å—è–Ω–∫–∞ 200–≥', '–∫–æ–Ω—Ñ–µ—Ç—É Raffaelo', '–∫–æ—Ä–Ω–∏—à–æ–Ω 5—à—Ç', '—á–∏–∑–±—É—Ä–≥–µ—Ä 1—à—Ç', '–π–æ–≥—É—Ä—Ç –ø—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π 290–≥'\n"
                "–ü—Ä–∏–º–µ—Ä—ã –ù–ï –ø—Ä–æ –µ–¥—É: '–ø—Ä–∏–≤–µ—Ç', '–∫–∞–∫ –¥–µ–ª–∞', '—á—Ç–æ –¥–µ–ª–∞–µ—à—å', '–ø–æ–≥–æ–¥–∞ —Ö–æ—Ä–æ—à–∞—è', '—Å–µ–≥–æ–¥–Ω—è –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫'\n\n"
                "–í–ê–ñ–ù–û: –ï—Å–ª–∏ —ç—Ç–æ —è–≤–Ω–æ –Ω–µ—Ü–µ–Ω–∑—É—Ä–Ω–æ–µ —Å–ª–æ–≤–æ –∏–ª–∏ —à—É—Ç–∫–∞ - –æ—Ç–≤–µ—á–∞–π 'no'.\n"
                "–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ 'yes' –∏–ª–∏ 'no', –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."
            )
            
            # –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –º–æ—â–Ω—É—é –º–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            models_to_try = [
                "llama-3.3-70b-versatile",
                "llama-3.1-70b-versatile",
                "llama-3.1-8b-instant"
            ]
            
            response = None
            for model_name in models_to_try:
                try:
                    response = self.groq_client.chat.completions.create(
                        model=model_name,
                        messages=[
                            {"role": "system", "content": "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫ –µ–¥–µ. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ 'yes' –∏–ª–∏ 'no'."},
                            {"role": "user", "content": prompt}
                        ],
                        temperature=0.1,
                        max_tokens=10
                    )
                    break
                except Exception:
                    continue
            
            if not response:
                # Fallback –Ω–∞ –ø—Ä–æ—Å—Ç—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
                return has_food_keyword or has_number_with_unit
            
            result = response.choices[0].message.content.strip().lower()
            is_food = result.startswith('yes') or result == '–¥–∞' or '–¥–∞' in result
            
            logger.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –µ–¥—É –¥–ª—è '{text}': {result} -> {is_food}")
            return is_food
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–∞ –µ–¥—É: {e}")
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
            return has_food_keyword or has_number_with_unit
    
    async def add_meal_from_text(self, user_id: int, text: str) -> Dict:
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Groq)"""
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç –∫ –µ–¥–µ
        is_food = await self.is_food_related(text)
        if not is_food:
            logger.info(f"–¢–µ–∫—Å—Ç '{text}' –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–∏–µ –µ–¥—ã")
            return {
                'success': False,
                'calories': 0,
                'total_today': 0,
                'message': '–≠—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏–µ –µ–¥—ã üòä\n\n–ù–∞–ø–∏—à–∏ —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ: "–ø–µ–ª—å–º–µ–Ω–∏ 250–≥" –∏–ª–∏ "—Å—ä–µ–ª —è–±–ª–æ–∫–æ"'
            }
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ Groq –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
        if not self.groq_client:
            logger.warning("Groq –∫–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Ç–µ–∫—Å—Ç")
            return {
                'success': False, 
                'calories': 0, 
                'total_today': 0,
                'message': 'Groq AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π —à—Ç—Ä–∏—Ö-–∫–æ–¥ –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.'
            }
        
        logger.info(f"–ü–∞—Ä—Å–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ Groq: {text}")
        groq_result = await self.parse_with_groq(text)
        
        if not groq_result or not groq_result.get('success'):
            logger.warning(f"Groq –Ω–µ —Å–º–æ–≥ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Ç–µ–∫—Å—Ç: {text}")
            return {
                'success': False,
                'calories': 0,
                'total_today': 0,
                'message': '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π —É–∫–∞–∑–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–≤–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–æ–≤—Å—è–Ω–∫–∞ 200–≥") –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π —à—Ç—Ä–∏—Ö-–∫–æ–¥ –ø—Ä–æ–¥—É–∫—Ç–∞.'
            }
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç Groq
        logger.info(f"Groq —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–∏–ª: {groq_result}")
        calories = groq_result['calories']
        meal_name = groq_result['meal_name']
        items = groq_result['items']
        source = groq_result.get('source', 'Groq AI')
        
        # –ü–æ–ª—É—á–∞–µ–º –ö–ë–ñ–£ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ Groq
        proteins = groq_result.get('proteins')
        fats = groq_result.get('fats')
        carbs = groq_result.get('carbs')
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        conn = self.get_connection()
        cursor = conn.cursor()
        
        today = date.today()
        cursor.execute("""
            INSERT INTO meals (user_id, meal_name, calories, date, source, proteins, fats, carbs)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        """, (user_id, meal_name, calories, today, source, proteins, fats, carbs))
        
        meal_id = cursor.lastrowid
        conn.commit()
        conn.close()
        
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–ª–æ—Ä–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è
        total_today = self.get_today_stats(user_id)['calories']
        
        return {
            'success': True,
            'calories': calories,
            'total_today': total_today,
            'items': items if isinstance(items, list) else [],
            'meal_name': meal_name,
            'source': source,
            'meal_id': meal_id,
            'proteins': proteins,
            'fats': fats,
            'carbs': carbs
        }
    
    def get_recent_meals(self, user_id: int, limit: int = 10) -> List[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT id, meal_name, calories, date, source, created_at
            FROM meals
            WHERE user_id = ?
            ORDER BY created_at DESC
            LIMIT ?
        """, (user_id, limit))
        
        results = cursor.fetchall()
        conn.close()
        
        meals = []
        for row in results:
            meals.append({
                'id': row['id'],
                'meal_name': row['meal_name'],
                'calories': row['calories'],
                'date': row['date'],
                'source': row['source'],
                'created_at': row['created_at']
            })
        
        return meals
    
    def delete_meal(self, user_id: int, meal_id: int) -> bool:
        """–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏ –ø–æ ID"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏–µ–º –ø–∏—â–∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        cursor.execute("""
            SELECT id FROM meals
            WHERE id = ? AND user_id = ?
        """, (meal_id, user_id))
        
        if not cursor.fetchone():
            conn.close()
            return False
        
        # –£–¥–∞–ª—è–µ–º –ø—Ä–∏–µ–º –ø–∏—â–∏
        cursor.execute("""
            DELETE FROM meals
            WHERE id = ? AND user_id = ?
        """, (meal_id, user_id))
        
        conn.commit()
        conn.close()
        return True
    
    def delete_last_meal(self, user_id: int) -> Optional[Dict]:
        """–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏–µ–º –ø–∏—â–∏
        cursor.execute("""
            SELECT id, meal_name, calories, date, source
            FROM meals
            WHERE user_id = ?
            ORDER BY created_at DESC
            LIMIT 1
        """, (user_id,))
        
        meal = cursor.fetchone()
        
        if meal:
            meal_id = meal['id']
            # –£–¥–∞–ª—è–µ–º
            cursor.execute("""
                DELETE FROM meals
                WHERE id = ? AND user_id = ?
            """, (meal_id, user_id))
            
            conn.commit()
            conn.close()
            
            return {
                'id': meal['id'],
                'meal_name': meal['meal_name'],
                'calories': meal['calories'],
                'date': meal['date'],
                'source': meal['source']
            }
        
        conn.close()
        return None
    
    def get_today_stats(self, user_id: int) -> Dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        today = date.today()
        cursor.execute("""
            SELECT SUM(calories) as total_calories,
                   SUM(proteins) as total_proteins,
                   SUM(fats) as total_fats,
                   SUM(carbs) as total_carbs,
                   COUNT(*) as meal_count,
                   GROUP_CONCAT(meal_name, '; ') as meals
            FROM meals
            WHERE user_id = ? AND date = ?
        """, (user_id, today))
        
        result = cursor.fetchone()
        conn.close()
        
        total_calories = result['total_calories'] or 0
        total_proteins = result['total_proteins'] or 0
        total_fats = result['total_fats'] or 0
        total_carbs = result['total_carbs'] or 0
        meal_count = result['meal_count'] or 0
        
        meals_list = []
        if result['meals']:
            meal_names = result['meals'].split('; ')
            for meal_name in meal_names:
                # –ü–æ–ª—É—á–∞–µ–º –∫–∞–ª–æ—Ä–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏
                conn = self.get_connection()
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT calories, proteins, fats, carbs FROM meals
                    WHERE user_id = ? AND date = ? AND meal_name = ?
                    LIMIT 1
                """, (user_id, today, meal_name))
                meal_result = cursor.fetchone()
                conn.close()
                
                if meal_result:
                    meals_list.append({
                        'name': meal_name,
                        'calories': meal_result['calories'],
                        'proteins': meal_result['proteins'] if 'proteins' in meal_result.keys() and meal_result['proteins'] is not None else None,
                        'fats': meal_result['fats'] if 'fats' in meal_result.keys() and meal_result['fats'] is not None else None,
                        'carbs': meal_result['carbs'] if 'carbs' in meal_result.keys() and meal_result['carbs'] is not None else None
                    })
        
        return {
            'calories': total_calories,
            'proteins': round(total_proteins, 1) if total_proteins else None,
            'fats': round(total_fats, 1) if total_fats else None,
            'carbs': round(total_carbs, 1) if total_carbs else None,
            'meal_count': meal_count,
            'meals': meals_list
        }
    
    def get_today_meals_list(self, user_id: int) -> List[Dict]:
        """–°–ø–∏—Å–æ–∫ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è —Å id (–¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è)"""
        conn = self.get_connection()
        cursor = conn.cursor()
        today = date.today()
        cursor.execute("""
            SELECT id, meal_name, calories, proteins, fats, carbs, source
            FROM meals
            WHERE user_id = ? AND date = ?
            ORDER BY created_at ASC
        """, (user_id, today))
        rows = cursor.fetchall()
        conn.close()
        meals = []
        for row in rows:
            meals.append({
                'id': row['id'],
                'meal_name': row['meal_name'],
                'calories': row['calories'] or 0,
                'proteins': row['proteins'],
                'fats': row['fats'],
                'carbs': row['carbs'],
                'source': row['source']
            })
        return meals
    
    def get_week_stats(self, user_id: int) -> Dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ –Ω–µ–¥–µ–ª—é"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        week_ago = date.today() - timedelta(days=7)
        
        cursor.execute("""
            SELECT date, SUM(calories) as daily_calories
            FROM meals
            WHERE user_id = ? AND date >= ?
            GROUP BY date
            ORDER BY date DESC
        """, (user_id, week_ago))
        
        days = []
        for row in cursor.fetchall():
            days.append({
                'date': datetime.strptime(row['date'], '%Y-%m-%d').date(),
                'calories': row['daily_calories'] or 0
            })
        
        conn.close()
        
        return {'days': days}
    
    def get_daily_limit(self, user_id: int) -> Optional[int]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–Ω–µ–≤–Ω–æ–π –Ω–æ—Ä–º—ã –∫–∞–ª–æ—Ä–∏–π"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT limit_calories FROM daily_limits
            WHERE user_id = ?
        """, (user_id,))
        
        result = cursor.fetchone()
        conn.close()
        
        return result['limit_calories'] if result else None
    
    def set_daily_limit(self, user_id: int, limit: int):
        """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–Ω–µ–≤–Ω–æ–π –Ω–æ—Ä–º—ã –∫–∞–ª–æ—Ä–∏–π"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        cursor.execute("""
            INSERT OR REPLACE INTO daily_limits (user_id, limit_calories, updated_at)
            VALUES (?, ?, CURRENT_TIMESTAMP)
        """, (user_id, limit))
        
        conn.commit()
        conn.close()
    
    async def search_product_by_barcode_openfoodfacts(self, barcode: str) -> Optional[Dict]:
        """–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–∞ –ø–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥—É —á–µ—Ä–µ–∑ Open Food Facts API"""
        try:
            url = f"https://world.openfoodfacts.org/api/v0/product/{barcode}.json"
            
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            }
            
            async with aiohttp.ClientSession() as session:
                async with session.get(url, headers=headers, timeout=aiohttp.ClientTimeout(total=15)) as response:
                    if response.status == 200:
                        data = await response.json()
                        
                        if data.get('status') == 1 and data.get('product'):
                            product = data['product']
                            
                            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–¥—É–∫—Ç–µ
                            product_name = product.get('product_name', '') or product.get('product_name_en', '') or product.get('product_name_ru', '')
                            if not product_name or not is_valid_product_name(product_name):
                                product_name = product.get('abbreviated_product_name', '')
                                if not product_name or not is_valid_product_name(product_name):
                                    # –ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                                    logger.debug(f"–ù–µ–≤–∞–ª–∏–¥–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ Open Food Facts: {product_name}")
                                    return None
                            
                            # –ü–æ–ª—É—á–∞–µ–º –ö–ë–ñ–£ (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—è—Ö)
                            calories = None
                            proteins = None
                            fats = None
                            carbs = None
                            
                            if 'nutriments' in product:
                                nutriments = product['nutriments']
                                
                                # –ö–∞–ª–æ—Ä–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö
                                calories = (
                                    nutriments.get('energy-kcal_100g') or
                                    nutriments.get('energy-kcal') or
                                    nutriments.get('energy_100g') or
                                    (nutriments.get('energy', 0) / 4.184 if nutriments.get('energy') else None)  # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑ –∫–î–∂
                                )
                                
                                # –ë–µ–ª–∫–∏ (–Ω–∞ 100–≥)
                                proteins = (
                                    nutriments.get('proteins_100g') or
                                    nutriments.get('proteins') or
                                    nutriments.get('protein_100g') or
                                    nutriments.get('protein')
                                )
                                
                                # –ñ–∏—Ä—ã (–Ω–∞ 100–≥)
                                fats = (
                                    nutriments.get('fat_100g') or
                                    nutriments.get('fats_100g') or
                                    nutriments.get('fat') or
                                    nutriments.get('fats')
                                )
                                
                                # –£–≥–ª–µ–≤–æ–¥—ã (–Ω–∞ 100–≥)
                                carbs = (
                                    nutriments.get('carbohydrates_100g') or
                                    nutriments.get('carbs_100g') or
                                    nutriments.get('carbohydrates') or
                                    nutriments.get('carbs')
                                )
                            
                            # –ï—Å–ª–∏ –∫–∞–ª–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                            if calories is None or calories == 0:
                                calories = 250  # –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
                            
                            # –ü–æ–ª—É—á–∞–µ–º –≤–µ—Å –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                            weight = None
                            
                            # 1. –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –∏–∑ –ø–æ–ª—è quantity
                            quantity = product.get('quantity', '') or product.get('product_quantity', '')
                            if quantity:
                                weight_match = re.search(r'(\d+)\s*(–≥|g|–∫–≥|kg|ml|–º–ª|l|–ª)', quantity, re.IGNORECASE)
                                if weight_match:
                                    weight = float(weight_match.group(1))
                                    unit = weight_match.group(2).lower()
                                    if unit in ['–∫–≥', 'kg']:
                                        weight *= 1000
                                    elif unit in ['–ª', 'l']:
                                        # –î–ª—è –∂–∏–¥–∫–æ—Å—Ç–µ–π —Å—á–∏—Ç–∞–µ–º 1–ª = 1000–≥ (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)
                                        weight = float(weight_match.group(1)) * 1000
                                    elif unit in ['–º–ª', 'ml']:
                                        # –î–ª—è –∂–∏–¥–∫–æ—Å—Ç–µ–π —Å—á–∏—Ç–∞–µ–º 1–º–ª = 1–≥ (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)
                                        weight = float(weight_match.group(1))
                            
                            # 2. –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
                            if weight is None:
                                # –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç–∏–ø–∞ "290–≥", "60–≥", "100–≥" –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
                                name_weight_match = re.search(r'(\d+)\s*(–≥|g|–∫–≥|kg)\b', product_name, re.IGNORECASE)
                                if name_weight_match:
                                    weight = float(name_weight_match.group(1))
                                    unit = name_weight_match.group(2).lower()
                                    if unit in ['–∫–≥', 'kg']:
                                        weight *= 1000
                            
                            # 3. –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –∏–∑ serving_size –∏–ª–∏ net_weight –µ—Å–ª–∏ –µ—Å—Ç—å
                            if weight is None:
                                serving_size = product.get('serving_size', '') or product.get('net_weight', '')
                                if serving_size:
                                    serving_match = re.search(r'(\d+)\s*(–≥|g|–∫–≥|kg)', serving_size, re.IGNORECASE)
                                    if serving_match:
                                        weight = float(serving_match.group(1))
                                        unit = serving_match.group(2).lower()
                                        if unit in ['–∫–≥', 'kg']:
                                            weight *= 1000
                            
                            return {
                                'success': True,
                                'name': product_name,
                                'calories_per_100g': int(calories) if calories else None,
                                'proteins_per_100g': round(proteins, 1) if proteins else None,
                                'fats_per_100g': round(fats, 1) if fats else None,
                                'carbs_per_100g': round(carbs, 1) if carbs else None,
                                'weight': weight,
                                'barcode': barcode,
                                'brand': product.get('brands', ''),
                                'image_url': product.get('image_url', ''),
                                'source': 'Open Food Facts'
                            }
                        else:
                            logger.warning(f"–ü—Ä–æ–¥—É–∫—Ç —Å —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–º {barcode} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ Open Food Facts")
                            return None
                    else:
                        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Open Food Facts API: {response.status}")
                        return None
        except asyncio.TimeoutError:
            logger.error(f"–¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Open Food Facts API –¥–ª—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ {barcode}")
            return None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –ø–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥—É {barcode}: {e}")
            return None
    
    async def search_product_by_barcode_upcitemdb(self, barcode: str) -> Optional[Dict]:
        """–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–∞ –ø–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥—É —á–µ—Ä–µ–∑ UPCitemdb API"""
        try:
            url = f"https://api.upcitemdb.com/prod/trial/lookup?upc={barcode}"
            
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            }
            
            async with aiohttp.ClientSession() as session:
                async with session.get(url, headers=headers, timeout=aiohttp.ClientTimeout(total=15)) as response:
                    if response.status == 200:
                        data = await response.json()
                        
                        if data.get('code') == 'OK' and data.get('items'):
                            item = data['items'][0]  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                            
                            product_name = item.get('title', '')
                            if not product_name or not is_valid_product_name(product_name):
                                logger.debug(f"–ù–µ–≤–∞–ª–∏–¥–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ UPCitemdb: {product_name}")
                                return None
                            brand = item.get('brand', '')
                            
                            # UPCitemdb –Ω–µ –≤—Å–µ–≥–¥–∞ –∏–º–µ–µ—Ç –ö–ë–ñ–£, –Ω–æ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ
                            # –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∏—Ç–∞–Ω–∏–∏ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏
                            description = item.get('description', '')
                            
                            # –ü–∞—Ä—Å–∏–º –ö–ë–ñ–£ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
                            calories = None
                            proteins = None
                            fats = None
                            carbs = None
                            
                            # –ò—â–µ–º —á–∏—Å–ª–∞ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ (–∫–∞–ª–æ—Ä–∏–∏ –æ–±—ã—á–Ω–æ —É–∫–∞–∑–∞–Ω—ã)
                            cal_match = re.search(r'(\d+)\s*(–∫–∫–∞–ª|–∫–∞–ª–æ—Ä–∏|calories|kcal)', description, re.IGNORECASE)
                            if cal_match:
                                calories = int(cal_match.group(1))
                            
                            # –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –≤–µ—Å –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
                            weight = None
                            if product_name:
                                name_weight_match = re.search(r'(\d+)\s*(–≥|g|–∫–≥|kg)\b', product_name, re.IGNORECASE)
                                if name_weight_match:
                                    weight = float(name_weight_match.group(1))
                                    unit = name_weight_match.group(2).lower()
                                    if unit in ['–∫–≥', 'kg']:
                                        weight *= 1000
                            
                            return {
                                'success': True,
                                'name': product_name,
                                'calories_per_100g': calories,
                                'proteins_per_100g': proteins,
                                'fats_per_100g': fats,
                                'carbs_per_100g': carbs,
                                'weight': weight,
                                'barcode': barcode,
                                'brand': brand,
                                'image_url': item.get('images', [None])[0] if item.get('images') else None,
                                'source': 'UPCitemdb',
                                'description': description
                            }
                        else:
                            logger.warning(f"–ü—Ä–æ–¥—É–∫—Ç —Å —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–º {barcode} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ UPCitemdb")
                            return None
                    else:
                        return None
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≤ UPCitemdb –¥–ª—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ {barcode}: {e}")
            return None
    
    async def search_product_by_barcode_barcodelookup(self, barcode: str) -> Optional[Dict]:
        """–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–∞ –ø–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥—É —á–µ—Ä–µ–∑ Barcode Lookup API"""
        try:
            # –ü—Ä–æ–±—É–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π API
            url = f"https://api.barcodelookup.com/v2/products"
            params = {'barcode': barcode, 'formatted': 'y', 'key': ''}  # –ú–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∫–ª—é—á–∞ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                'Accept': 'application/json'
            }
            
            async with aiohttp.ClientSession() as session:
                async with session.get(url, params=params, headers=headers, timeout=aiohttp.ClientTimeout(total=15)) as response:
                    if response.status == 200:
                        data = await response.json()
                        
                        if data.get('products') and len(data['products']) > 0:
                            product = data['products'][0]
                            
                            product_name = product.get('product_name', '') or product.get('title', '')
                            if not product_name or not is_valid_product_name(product_name):
                                logger.debug(f"–ù–µ–≤–∞–ª–∏–¥–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ Barcode Lookup: {product_name}")
                                return None
                            brand = product.get('brand', '')
                            
                            # Barcode Lookup –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∏—Ç–∞–Ω–∏–∏
                            nutrition = product.get('nutrition_facts', {}) or product.get('nutrition', {})
                            
                            calories = nutrition.get('calories') or nutrition.get('energy')
                            proteins = nutrition.get('protein') or nutrition.get('proteins')
                            fats = nutrition.get('fat') or nutrition.get('fats')
                            carbs = nutrition.get('carbohydrates') or nutrition.get('carbs')
                            
                            # –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –≤–µ—Å –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
                            weight = None
                            if product_name:
                                name_weight_match = re.search(r'(\d+)\s*(–≥|g|–∫–≥|kg)\b', product_name, re.IGNORECASE)
                                if name_weight_match:
                                    weight = float(name_weight_match.group(1))
                                    unit = name_weight_match.group(2).lower()
                                    if unit in ['–∫–≥', 'kg']:
                                        weight *= 1000
                            
                            return {
                                'success': True,
                                'name': product_name,
                                'calories_per_100g': int(calories) if calories else None,
                                'proteins_per_100g': round(float(proteins), 1) if proteins else None,
                                'fats_per_100g': round(float(fats), 1) if fats else None,
                                'carbs_per_100g': round(float(carbs), 1) if carbs else None,
                                'weight': weight,
                                'barcode': barcode,
                                'brand': brand,
                                'image_url': product.get('images', [None])[0] if product.get('images') else None,
                                'source': 'Barcode Lookup'
                            }
                        else:
                            return None
                    else:
                        return None
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≤ Barcode Lookup –¥–ª—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ {barcode}: {e}")
            return None
    
    async def search_product_by_barcode_web(self, barcode: str) -> Optional[Dict]:
        """–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–∞ —á–µ—Ä–µ–∑ –≤–µ–±-–ø–æ–∏—Å–∫ (–∏—Å–ø–æ–ª—å–∑—É—è Open Food Facts –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –¥—Ä—É–≥–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏)"""
        try:
            import re
            
            # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —á–µ—Ä–µ–∑ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—É Open Food Facts
            url = f"https://world.openfoodfacts.org/product/{barcode}"
            
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            }
            
            async with aiohttp.ClientSession() as session:
                async with session.get(url, headers=headers, timeout=aiohttp.ClientTimeout(total=15)) as response:
                    if response.status == 200:
                        html = await response.text()
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–æ–¥—É–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–Ω–µ 404)
                        if 'Product not found' in html or 'not found' in html.lower() or '404' in html:
                            logger.debug(f"–ü—Ä–æ–¥—É–∫—Ç {barcode} –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Open Food Facts")
                            return None
                        
                        # –ò—â–µ–º JSON –¥–∞–Ω–Ω—ã–µ –≤ HTML (Open Food Facts —á–∞—Å—Ç–æ –≤—Å—Ç–∞–≤–ª—è–µ—Ç –∏—Ö –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—É)
                        json_match = re.search(r'<script[^>]*type=["\']application/ld\+json["\'][^>]*>(.*?)</script>', html, re.DOTALL | re.IGNORECASE)
                        if json_match:
                            try:
                                import json
                                json_data = json.loads(json_match.group(1))
                                if isinstance(json_data, dict):
                                    name = json_data.get('name') or json_data.get('product_name')
                                    if name:
                                        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ö–ë–ñ–£ –≤ JSON
                                        nutrition = json_data.get('nutrition', {}) or json_data.get('nutriments', {})
                                        calories = nutrition.get('calories') or nutrition.get('energy-kcal_100g')
                                        proteins = nutrition.get('proteins_100g') or nutrition.get('protein_100g')
                                        fats = nutrition.get('fats_100g') or nutrition.get('fat_100g')
                                        carbs = nutrition.get('carbohydrates_100g') or nutrition.get('carbs_100g')
                                        
                                        # –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –≤–µ—Å –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
                                        weight = None
                                        if name:
                                            name_weight_match = re.search(r'(\d+)\s*(–≥|g|–∫–≥|kg)\b', name, re.IGNORECASE)
                                            if name_weight_match:
                                                weight = float(name_weight_match.group(1))
                                                unit = name_weight_match.group(2).lower()
                                                if unit in ['–∫–≥', 'kg']:
                                                    weight *= 1000
                                        
                                        return {
                                            'success': True,
                                            'name': name,
                                            'calories_per_100g': int(calories) if calories else None,
                                            'proteins_per_100g': round(float(proteins), 1) if proteins else None,
                                            'fats_per_100g': round(float(fats), 1) if fats else None,
                                            'carbs_per_100g': round(float(carbs), 1) if carbs else None,
                                            'weight': weight,
                                            'barcode': barcode,
                                            'brand': json_data.get('brand', ''),
                                            'image_url': json_data.get('image'),
                                            'source': 'Open Food Facts (Web)'
                                        }
                            except json.JSONDecodeError:
                                pass
                        
                        # –ï—Å–ª–∏ JSON –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º –≤ HTML
                        # –ò—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö HTML
                        name_patterns = [
                            r'<h1[^>]*property=["\']food:name["\'][^>]*>([^<]+)</h1>',
                            r'<h1[^>]*>([^<]+)</h1>',
                            r'<title>([^<]+)</title>',
                            r'product_name["\']?\s*[:=]\s*["\']([^"\']+)["\']',
                            r'"product_name"\s*:\s*"([^"]+)"',
                        ]
                        
                        product_name = None
                        for pattern in name_patterns:
                            match = re.search(pattern, html, re.IGNORECASE)
                            if match:
                                product_name = match.group(1).strip()
                                # –û—á–∏—â–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç –ª–∏—à–Ω–µ–≥–æ
                                product_name = re.sub(r'\s*-\s*Open Food Facts.*$', '', product_name, flags=re.IGNORECASE)
                                product_name = re.sub(r'\s*-\s*.*$', '', product_name, flags=re.IGNORECASE)  # –£–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ –¥–µ—Ñ–∏—Å–∞
                                if is_valid_product_name(product_name):
                                    break
                                else:
                                    product_name = None
                        
                        if product_name and is_valid_product_name(product_name):
                            # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ö–ë–ñ–£ –≤ HTML —á–µ—Ä–µ–∑ –±–æ–ª–µ–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
                            calories = None
                            proteins = None
                            fats = None
                            carbs = None
                            
                            # –ò—â–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ö–ë–ñ–£ –≤ HTML (—Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã)
                            cal_patterns = [
                                r'(\d+)\s*(–∫–∫–∞–ª|–∫–∞–ª–æ—Ä–∏|kcal|calories)\s*(?:–Ω–∞|per|/)\s*100',
                                r'energy[_-]?kcal[_-]?100g["\']?\s*:\s*(\d+)',
                                r'–∫–∞–ª–æ—Ä–∏–∏["\']?\s*:\s*(\d+)',
                            ]
                            for pattern in cal_patterns:
                                cal_match = re.search(pattern, html, re.IGNORECASE)
                                if cal_match:
                                    calories = int(cal_match.group(1))
                                    break
                            
                            # –ò—â–µ–º –±–µ–ª–∫–∏
                            prot_patterns = [
                                r'–±–µ–ª–∫–∏["\']?\s*:\s*(\d+\.?\d*)',
                                r'proteins?[_-]?100g["\']?\s*:\s*(\d+\.?\d*)',
                            ]
                            for pattern in prot_patterns:
                                prot_match = re.search(pattern, html, re.IGNORECASE)
                                if prot_match:
                                    proteins = round(float(prot_match.group(1)), 1)
                                    break
                            
                            # –ò—â–µ–º –∂–∏—Ä—ã
                            fat_patterns = [
                                r'–∂–∏—Ä—ã["\']?\s*:\s*(\d+\.?\d*)',
                                r'fats?[_-]?100g["\']?\s*:\s*(\d+\.?\d*)',
                            ]
                            for pattern in fat_patterns:
                                fat_match = re.search(pattern, html, re.IGNORECASE)
                                if fat_match:
                                    fats = round(float(fat_match.group(1)), 1)
                                    break
                            
                            # –ò—â–µ–º —É–≥–ª–µ–≤–æ–¥—ã
                            carb_patterns = [
                                r'—É–≥–ª–µ–≤–æ–¥—ã["\']?\s*:\s*(\d+\.?\d*)',
                                r'carbohydrates?[_-]?100g["\']?\s*:\s*(\d+\.?\d*)',
                            ]
                            for pattern in carb_patterns:
                                carb_match = re.search(pattern, html, re.IGNORECASE)
                                if carb_match:
                                    carbs = round(float(carb_match.group(1)), 1)
                                    break
                            
                            return {
                                'success': True,
                                'name': product_name,
                                'calories_per_100g': calories,
                                'proteins_per_100g': proteins,
                                'fats_per_100g': fats,
                                'carbs_per_100g': carbs,
                                'weight': None,
                                'barcode': barcode,
                                'brand': '',
                                'image_url': None,
                                'source': 'Open Food Facts (Web)'
                            }
                        else:
                            return None
                    else:
                        return None
        except asyncio.TimeoutError:
            logger.debug(f"–¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –≤–µ–±-–ø–æ–∏—Å–∫–µ –¥–ª—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ {barcode}")
            return None
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–µ–±-–ø–æ–∏—Å–∫–µ –¥–ª—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ {barcode}: {e}")
            return None
    
    async def search_product_by_barcode(self, barcode: str, status_callback=None) -> Optional[Dict]:
        """–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–∞ –ø–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥—É —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        
        Args:
            barcode: –®—Ç—Ä–∏—Ö-–∫–æ–¥ –ø—Ä–æ–¥—É–∫—Ç–∞
            status_callback: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–∏—Å–∫–∞ (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Ç—Ä–æ–∫—É —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º)
        """
        def is_valid_result(result: Optional[Dict]) -> bool:
            """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–∏—Å–∫–∞"""
            if not result or not result.get('success'):
                return False
            name = result.get('name', '').strip()
            if not name:
                return False
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å–ª—É–∂–µ–±–Ω—ã–º —Å–ª–æ–≤–æ–º
            invalid_names = ['–ø–æ–∏—Å–∫', 'search', 'product', '—Ç–æ–≤–∞—Ä', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π', 'unknown', 'barcode', '—à—Ç—Ä–∏—Ö-–∫–æ–¥']
            if name.lower() in invalid_names:
                return False
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é is_valid_product_name
            return is_valid_product_name(name)
        
        # –ü—Ä–æ–±—É–µ–º —Å–Ω–∞—á–∞–ª–∞ Open Food Facts API (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ —Å –ö–ë–ñ–£)
        if status_callback:
            await status_callback("üîç –ò—â—É –≤ Open Food Facts API...")
        logger.info(f"–ò—â—É –ø—Ä–æ–¥—É–∫—Ç {barcode} –≤ Open Food Facts API...")
        result = await self.search_product_by_barcode_openfoodfacts(barcode)
        if is_valid_result(result):
            logger.info(f"–ü—Ä–æ–¥—É–∫—Ç –Ω–∞–π–¥–µ–Ω –≤ Open Food Facts API")
            return result
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–±—É–µ–º UPCitemdb
        if status_callback:
            await status_callback("üîç –ò—â—É –≤ UPCitemdb...")
        logger.info(f"–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Open Food Facts API, –ø—Ä–æ–±—É–µ–º UPCitemdb...")
        result = await self.search_product_by_barcode_upcitemdb(barcode)
        if is_valid_result(result):
            logger.info(f"–ü—Ä–æ–¥—É–∫—Ç –Ω–∞–π–¥–µ–Ω –≤ UPCitemdb")
            return result
        
        # –ü—Ä–æ–±—É–µ–º Barcode Lookup
        if status_callback:
            await status_callback("üîç –ò—â—É –≤ Barcode Lookup...")
        logger.info(f"–ü—Ä–æ–±—É–µ–º Barcode Lookup...")
        result = await self.search_product_by_barcode_barcodelookup(barcode)
        if is_valid_result(result):
            logger.info(f"–ü—Ä–æ–¥—É–∫—Ç –Ω–∞–π–¥–µ–Ω –≤ Barcode Lookup")
            return result
        
        # –ü—Ä–æ–±—É–µ–º –≤–µ–±-–ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Open Food Facts
        if status_callback:
            await status_callback("üîç –ò—â—É –Ω–∞ —Å–∞–π—Ç–µ Open Food Facts...")
        logger.info(f"–ü—Ä–æ–±—É–µ–º –≤–µ–±-–ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Open Food Facts...")
        result = await self.search_product_by_barcode_web(barcode)
        if is_valid_result(result):
            logger.info(f"–ü—Ä–æ–¥—É–∫—Ç –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ –≤–µ–±-–ø–æ–∏—Å–∫ Open Food Facts")
            return result
        
        # –ü—Ä–æ–±—É–µ–º –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ –¥—Ä—É–≥–∏–µ –≤–µ–±-–∏—Å—Ç–æ—á–Ω–∏–∫–∏ (—Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –±–∞–∑—ã –∏ –ø–æ–∏—Å–∫–æ–≤–∏–∫–∏)
        if status_callback:
            await status_callback("üîç –ò—â—É –≤ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –±–∞–∑–∞—Ö –¥–∞–Ω–Ω—ã—Ö...")
        logger.info(f"–ü—Ä–æ–±—É–µ–º –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ –¥—Ä—É–≥–∏–µ –≤–µ–±-–∏—Å—Ç–æ—á–Ω–∏–∫–∏...")
        result = await self.search_product_by_barcode_web_alternative(barcode)
        if is_valid_result(result):
            logger.info(f"–ü—Ä–æ–¥—É–∫—Ç –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–µ–±-–∏—Å—Ç–æ—á–Ω–∏–∫–∏")
            return result
        
        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Groq –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
        # (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏)
        if self.groq_client:
            if status_callback:
                await status_callback("üîç –ò—â—É —á–µ—Ä–µ–∑ AI...")
            logger.info(f"–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏, –ø—Ä–æ–±—É–µ–º Groq –¥–ª—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ {barcode}")
            try:
                # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–¥—É–∫—Ç–µ —á–µ—Ä–µ–∑ Groq
                groq_prompt = f"–ù–∞–π–¥–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–¥—É–∫—Ç–µ —Å–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–º {barcode}. –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –Ω–∞–π—Ç–∏ - –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É."
                response = self.groq_client.chat.completions.create(
                    model="llama-3.3-70b-versatile",
                    messages=[
                        {"role": "system", "content": "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ø—Ä–æ–¥—É–∫—Ç–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –∏–ª–∏ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π, –µ—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –Ω–∞–π—Ç–∏."},
                        {"role": "user", "content": groq_prompt}
                    ],
                    temperature=0.1,
                    max_tokens=50
                )
                product_name = response.choices[0].message.content.strip()
                
                if product_name and is_valid_product_name(product_name) and len(product_name) > 3:
                    logger.info(f"Groq –Ω–∞—à–µ–ª –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞: {product_name}")
                    return {
                        'success': True,
                        'name': product_name,
                        'calories_per_100g': None,
                        'proteins_per_100g': None,
                        'fats_per_100g': None,
                        'carbs_per_100g': None,
                        'weight': None,
                        'barcode': barcode,
                        'brand': '',
                        'image_url': None,
                        'source': 'Groq AI (–ø–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥—É)'
                    }
            except Exception as e:
                logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Groq –¥–ª—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞: {e}")
        
        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
        logger.warning(f"–ü—Ä–æ–¥—É–∫—Ç —Å —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–º {barcode} –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –≤ –æ–¥–Ω–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ")
        return None
    
    async def search_product_by_barcode_web_alternative(self, barcode: str) -> Optional[Dict]:
        """–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–µ–±-–ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ –¥—Ä—É–≥–∏–µ —Å–∞–π—Ç—ã"""
        try:
            import re
            
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
            }
            
            async with aiohttp.ClientSession() as session:
                # –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ ean-online.ru (–±–æ–ª–µ–µ 27 –º–ª–Ω —Ç–æ–≤–∞—Ä–æ–≤)
                url = f"https://ean-online.ru/{barcode}"
                try:
                    async with session.get(url, headers=headers, timeout=aiohttp.ClientTimeout(total=15)) as response:
                        if response.status == 200:
                            html = await response.text()
                            
                            # –ò—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ - –ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
                            name_patterns = [
                                r'<h1[^>]*>([^<]+)</h1>',
                                r'<title>([^<]+)</title>',
                                r'product[_-]?name["\']?\s*:\s*["\']([^"\']+)["\']',
                                r'–Ω–∞–∑–≤–∞–Ω–∏–µ[^>]*>([^<]+)',
                                r'<div[^>]*class=["\'][^"\']*name[^"\']*["\'][^>]*>([^<]+)</div>',
                                r'<td[^>]*>–ù–∞–∑–≤–∞–Ω–∏–µ[^<]*</td>\s*<td[^>]*>([^<]+)</td>',
                                r'<span[^>]*>([–ê-–Ø–∞-—è–Å—ëA-Za-z][–ê-–Ø–∞-—è–Å—ëA-Za-z0-9\s\-]{3,})</span>',
                                r'<p[^>]*>([–ê-–Ø–∞-—è–Å—ëA-Za-z][–ê-–Ø–∞-—è–Å—ëA-Za-z0-9\s\-]{3,})</p>',
                            ]
                            
                            product_name = None
                            brand = None
                            weight = None
                            
                            # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                            for pattern in name_patterns:
                                name_match = re.search(pattern, html, re.IGNORECASE | re.MULTILINE)
                                if name_match:
                                    candidate_name = name_match.group(1).strip()
                                    # –û—á–∏—â–∞–µ–º –æ—Ç –ª–∏—à–Ω–µ–≥–æ
                                    candidate_name = re.sub(r'\s*-\s*EAN.*$', '', candidate_name, flags=re.IGNORECASE)
                                    candidate_name = re.sub(r'\s*-\s*ean-online.*$', '', candidate_name, flags=re.IGNORECASE)
                                    candidate_name = re.sub(r'\s*-\s*.*$', '', candidate_name, flags=re.IGNORECASE)
                                    candidate_name = re.sub(r'^\d+\s*', '', candidate_name)  # –£–±–∏—Ä–∞–µ–º —à—Ç—Ä–∏—Ö-–∫–æ–¥ –≤ –Ω–∞—á–∞–ª–µ
                                    candidate_name = candidate_name.strip()
                                    
                                    if candidate_name and is_valid_product_name(candidate_name):
                                        product_name = candidate_name
                                        break
                            
                            # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ª—é–±–æ–µ –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                            if not product_name:
                                # –ò—â–µ–º —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ—Ö–æ–∂ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ (—Å–æ–¥–µ—Ä–∂–∏—Ç –±—É–∫–≤—ã, –Ω–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π)
                                text_matches = re.findall(r'>([–ê-–Ø–∞-—è–Å—ëA-Za-z][–ê-–Ø–∞-—è–Å—ëA-Za-z0-9\s\-]{5,50})<', html)
                                for match in text_matches:
                                    candidate = match.strip()
                                    if is_valid_product_name(candidate) and len(candidate) > 5:
                                        product_name = candidate
                                        break
                            
                            # –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –≤–µ—Å –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                            if product_name:
                                weight_match = re.search(r'(\d+)\s*(–≥|g|–∫–≥|kg)\b', product_name, re.IGNORECASE)
                                if weight_match:
                                    weight = float(weight_match.group(1))
                                    unit = weight_match.group(2).lower()
                                    if unit in ['–∫–≥', 'kg']:
                                        weight *= 1000
                            
                            # –ò—â–µ–º –±—Ä–µ–Ω–¥
                            brand_patterns = [
                                r'–±—Ä–µ–Ω–¥[^>]*>([^<]+)',
                                r'brand["\']?\s*:\s*["\']([^"\']+)["\']',
                                r'–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å[^>]*>([^<]+)',
                            ]
                            for pattern in brand_patterns:
                                brand_match = re.search(pattern, html, re.IGNORECASE)
                                if brand_match:
                                    brand = brand_match.group(1).strip()
                                    if brand and len(brand) > 2:
                                        break
                            
                            if product_name and is_valid_product_name(product_name):
                                logger.info(f"–ü—Ä–æ–¥—É–∫—Ç –Ω–∞–π–¥–µ–Ω –Ω–∞ ean-online.ru: {product_name}")
                                return {
                                    'success': True,
                                    'name': product_name,
                                    'calories_per_100g': None,
                                    'proteins_per_100g': None,
                                    'fats_per_100g': None,
                                    'carbs_per_100g': None,
                                    'weight': weight,
                                    'barcode': barcode,
                                    'brand': brand or '',
                                    'image_url': None,
                                    'source': 'EAN-Online.ru'
                                }
                except Exception as e:
                    logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≤ ean-online.ru: {e}")
                
                # –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ barcode-list.ru
                url = f"https://barcode-list.ru/barcode/{barcode}.htm"
                try:
                    async with session.get(url, headers=headers, timeout=aiohttp.ClientTimeout(total=15)) as response:
                        if response.status == 200:
                            html = await response.text()
                            
                            name_patterns = [
                                r'<h1[^>]*>([^<]+)</h1>',
                                r'<title>([^<]+)</title>',
                                r'Product Name[^>]*>([^<]+)',
                            ]
                            
                            product_name = None
                            for pattern in name_patterns:
                                name_match = re.search(pattern, html, re.IGNORECASE)
                                if name_match:
                                    product_name = name_match.group(1).strip()
                                    product_name = re.sub(r'\s*-\s*Barcode.*$', '', product_name, flags=re.IGNORECASE)
                                    product_name = re.sub(r'\s*-\s*.*$', '', product_name, flags=re.IGNORECASE)
                                    if is_valid_product_name(product_name):
                                        break
                                    else:
                                        product_name = None
                            
                            if product_name and is_valid_product_name(product_name):
                                logger.info(f"–ü—Ä–æ–¥—É–∫—Ç –Ω–∞–π–¥–µ–Ω –Ω–∞ barcode-list.ru: {product_name}")
                                return {
                                    'success': True,
                                    'name': product_name,
                                    'calories_per_100g': None,
                                    'proteins_per_100g': None,
                                    'fats_per_100g': None,
                                    'carbs_per_100g': None,
                                    'weight': None,
                                    'barcode': barcode,
                                    'brand': '',
                                    'image_url': None,
                                    'source': 'Barcode-List.ru'
                                }
                except Exception as e:
                    logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≤ barcode-list.ru: {e}")
                
                # –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ barcodesdatabase.org
                url = f"https://barcodesdatabase.org/barcode/{barcode}"
                try:
                    async with session.get(url, headers=headers, timeout=aiohttp.ClientTimeout(total=15)) as response:
                        if response.status == 200:
                            html = await response.text()
                            
                            name_patterns = [
                                r'<h1[^>]*>([^<]+)</h1>',
                                r'<title>([^<]+)</title>',
                                r'product[_-]?name["\']?\s*:\s*["\']([^"\']+)["\']',
                            ]
                            
                            product_name = None
                            for pattern in name_patterns:
                                name_match = re.search(pattern, html, re.IGNORECASE)
                                if name_match:
                                    product_name = name_match.group(1).strip()
                                    product_name = re.sub(r'\s*-\s*Barcode.*$', '', product_name, flags=re.IGNORECASE)
                                    product_name = re.sub(r'\s*-\s*.*$', '', product_name, flags=re.IGNORECASE)
                                    if is_valid_product_name(product_name):
                                        break
                                    else:
                                        product_name = None
                            
                            if product_name and is_valid_product_name(product_name):
                                logger.info(f"–ü—Ä–æ–¥—É–∫—Ç –Ω–∞–π–¥–µ–Ω –Ω–∞ barcodesdatabase.org: {product_name}")
                                return {
                                    'success': True,
                                    'name': product_name,
                                    'calories_per_100g': None,
                                    'proteins_per_100g': None,
                                    'fats_per_100g': None,
                                    'carbs_per_100g': None,
                                    'weight': None,
                                    'barcode': barcode,
                                    'brand': '',
                                    'image_url': None,
                                    'source': 'BarcodesDatabase.org'
                                }
                except Exception as e:
                    logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≤ barcodesdatabase.org: {e}")
                
                # –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ gepir.gs1ru.org (—Ä–æ—Å—Å–∏–π—Å–∫–∞—è –±–∞–∑–∞ GS1)
                url = f"https://gepir.gs1ru.org/v4/gtin/{barcode}"
                try:
                    async with session.get(url, headers=headers, timeout=aiohttp.ClientTimeout(total=15)) as response:
                        if response.status == 200:
                            try:
                                data = await response.json()
                                # GS1 API –æ–±—ã—á–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–æ–¥—É–∫—Ç–µ
                                product_name = data.get('productName') or data.get('name') or data.get('description')
                                brand = data.get('brand') or data.get('manufacturer')
                                
                                if product_name and is_valid_product_name(product_name):
                                    logger.info(f"–ü—Ä–æ–¥—É–∫—Ç –Ω–∞–π–¥–µ–Ω –Ω–∞ gepir.gs1ru.org: {product_name}")
                                    return {
                                        'success': True,
                                        'name': product_name,
                                        'calories_per_100g': None,
                                        'proteins_per_100g': None,
                                        'fats_per_100g': None,
                                        'carbs_per_100g': None,
                                        'weight': None,
                                        'barcode': barcode,
                                        'brand': brand or '',
                                        'image_url': None,
                                        'source': 'GS1 Russia (GEPIR)'
                                    }
                            except Exception as json_error:
                                logger.debug(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç gepir.gs1ru.org: {json_error}")
                except Exception as e:
                    logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≤ gepir.gs1ru.org: {e}")
                
                # –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ upcdatabase.com
                url = f"https://www.upcdatabase.com/item/{barcode}"
                try:
                    async with session.get(url, headers=headers, timeout=aiohttp.ClientTimeout(total=15)) as response:
                        if response.status == 200:
                            html = await response.text()
                            
                            # –ò—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
                            name_patterns = [
                                r'<h[12][^>]*>([^<]+)</h[12]>',
                                r'<title>([^<]+)</title>',
                                r'Description[^>]*>([^<]+)',
                                r'Product[^>]*>([^<]+)',
                            ]
                            
                            product_name = None
                            for pattern in name_patterns:
                                name_match = re.search(pattern, html, re.IGNORECASE)
                                if name_match:
                                    product_name = name_match.group(1).strip()
                                    # –û—á–∏—â–∞–µ–º –æ—Ç –ª–∏—à–Ω–µ–≥–æ
                                    product_name = re.sub(r'\s*-\s*UPC.*$', '', product_name, flags=re.IGNORECASE)
                                    product_name = re.sub(r'\s*-\s*.*$', '', product_name, flags=re.IGNORECASE)  # –£–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ –¥–µ—Ñ–∏—Å–∞
                                    if is_valid_product_name(product_name):
                                        break
                                    else:
                                        product_name = None
                            
                            if product_name and is_valid_product_name(product_name):
                                return {
                                    'success': True,
                                    'name': product_name,
                                    'calories_per_100g': None,
                                    'proteins_per_100g': None,
                                    'fats_per_100g': None,
                                    'carbs_per_100g': None,
                                    'weight': None,
                                    'barcode': barcode,
                                    'brand': '',
                                    'image_url': None,
                                    'source': 'UPC Database (Web)'
                                }
                except Exception as e:
                    logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≤ upcdatabase.com: {e}")
                
                # –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ barcode-list.com
                url = f"https://barcode-list.com/barcode/{barcode}.htm"
                try:
                    async with session.get(url, headers=headers, timeout=aiohttp.ClientTimeout(total=15)) as response:
                        if response.status == 200:
                            html = await response.text()
                            
                            # –ò—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
                            name_patterns = [
                                r'<h1[^>]*>([^<]+)</h1>',
                                r'<title>([^<]+)</title>',
                                r'Product Name[^>]*>([^<]+)',
                            ]
                            
                            product_name = None
                            for pattern in name_patterns:
                                name_match = re.search(pattern, html, re.IGNORECASE)
                                if name_match:
                                    product_name = name_match.group(1).strip()
                                    product_name = re.sub(r'\s*-\s*Barcode.*$', '', product_name, flags=re.IGNORECASE)
                                    product_name = re.sub(r'\s*-\s*.*$', '', product_name, flags=re.IGNORECASE)  # –£–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ –¥–µ—Ñ–∏—Å–∞
                                    if is_valid_product_name(product_name):
                                        break
                                    else:
                                        product_name = None
                            
                            if product_name and is_valid_product_name(product_name):
                                return {
                                    'success': True,
                                    'name': product_name,
                                    'calories_per_100g': None,
                                    'proteins_per_100g': None,
                                    'fats_per_100g': None,
                                    'carbs_per_100g': None,
                                    'weight': None,
                                    'barcode': barcode,
                                    'brand': '',
                                    'image_url': None,
                                    'source': 'Barcode List (Web)'
                                }
                except Exception as e:
                    logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≤ barcode-list.com: {e}")
                
                # –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫ –≤ –Ø–Ω–¥–µ–∫—Å (–ª—É—á—à–µ –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤)
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–∞
                search_url = f"https://yandex.ru/search/?text={barcode}+—Ç–æ–≤–∞—Ä+–∫—É–ø–∏—Ç—å"
                try:
                    async with session.get(search_url, headers=headers, timeout=aiohttp.ClientTimeout(total=15)) as response:
                        if response.status == 200:
                            html = await response.text()
                            
                            # –ò—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞ –Ø–Ω–¥–µ–∫—Å
                            name_patterns = [
                                r'<h2[^>]*class=["\'][^"\']*organic__title[^"\']*["\'][^>]*>([^<]+)</h2>',
                                r'<a[^>]*class=["\'][^"\']*organic__url[^"\']*["\'][^>]*>([^<]+)</a>',
                                r'<h2[^>]*>([^<]+)</h2>',
                                r'<span[^>]*class=["\'][^"\']*organic__url-text[^"\']*["\'][^>]*>([^<]+)</span>',
                                r'<div[^>]*class=["\'][^"\']*serp-item[^"\']*["\'][^>]*>.*?<h2[^>]*>([^<]+)</h2>',
                            ]
                            
                            product_name = None
                            for pattern in name_patterns:
                                matches = re.findall(pattern, html, re.IGNORECASE | re.DOTALL)
                                for match in matches[:10]:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–µ 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                                    name = match.strip()
                                    # –û—á–∏—â–∞–µ–º –æ—Ç HTML-—Å—É—â–Ω–æ—Å—Ç–µ–π –∏ –ª–∏—à–Ω–µ–≥–æ
                                    name = re.sub(r'&[a-z]+;', '', name)
                                    name = re.sub(r'&nbsp;', ' ', name)
                                    name = re.sub(r'&quot;', '"', name)
                                    name = re.sub(r'&amp;', '&', name)
                                    name = re.sub(r'\s+', ' ', name).strip()
                                    # –£–±–∏—Ä–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –º–∞–≥–∞–∑–∏–Ω—ã –∏ –ª–∏—à–Ω–µ–µ
                                    name = re.sub(r'\s*-\s*[–ê-–Ø–∞-—è–Å—ëA-Za-z\s]+\.ru.*$', '', name, flags=re.IGNORECASE)
                                    name = re.sub(r'\s*-\s*–∫—É–ø–∏—Ç—å.*$', '', name, flags=re.IGNORECASE)
                                    name = re.sub(r'\s*-\s*—Ü–µ–Ω–∞.*$', '', name, flags=re.IGNORECASE)
                                    # –§–∏–ª—å—Ç—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –Ø–Ω–¥–µ–∫—Å
                                    if is_valid_product_name(name) and len(name) > 5:
                                        if '—è–Ω–¥–µ–∫—Å' not in name.lower() and 'yandex' not in name.lower():
                                            product_name = name
                                            break
                                if product_name:
                                    break
                            
                            if product_name and is_valid_product_name(product_name):
                                logger.info(f"–ü—Ä–æ–¥—É–∫—Ç –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å: {product_name}")
                                return {
                                    'success': True,
                                    'name': product_name,
                                    'calories_per_100g': None,
                                    'proteins_per_100g': None,
                                    'fats_per_100g': None,
                                    'carbs_per_100g': None,
                                    'weight': None,
                                    'barcode': barcode,
                                    'brand': '',
                                    'image_url': None,
                                    'source': '–Ø–Ω–¥–µ–∫—Å –ü–æ–∏—Å–∫'
                                }
                except Exception as e:
                    logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≤ –Ø–Ω–¥–µ–∫—Å: {e}")
                
                # –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫ –≤ Google —Å –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
                search_url = f"https://www.google.com/search?q={barcode}+product+–∫—É–ø–∏—Ç—å"
                try:
                    async with session.get(search_url, headers=headers, timeout=aiohttp.ClientTimeout(total=15)) as response:
                        if response.status == 200:
                            html = await response.text()
                            
                            # –ò—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞
                            # Google —á–∞—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ –ø–µ—Ä–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
                            name_patterns = [
                                r'<h3[^>]*>([^<]+)</h3>',
                                r'<a[^>]*><h3[^>]*>([^<]+)</h3></a>',
                                r'<div[^>]*class=["\'][^"\']*g[^"\']*["\'][^>]*>.*?<h3[^>]*>([^<]+)</h3>',
                            ]
                            
                            product_name = None
                            for pattern in name_patterns:
                                matches = re.findall(pattern, html, re.IGNORECASE | re.DOTALL)
                                for match in matches[:10]:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–µ 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                                    name = match.strip()
                                    # –û—á–∏—â–∞–µ–º –æ—Ç HTML-—Å—É—â–Ω–æ—Å—Ç–µ–π –∏ –ª–∏—à–Ω–µ–≥–æ
                                    name = re.sub(r'&[a-z]+;', '', name)
                                    name = re.sub(r'&nbsp;', ' ', name)
                                    name = re.sub(r'&quot;', '"', name)
                                    name = re.sub(r'&amp;', '&', name)
                                    name = re.sub(r'\s+', ' ', name).strip()
                                    # –£–±–∏—Ä–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –º–∞–≥–∞–∑–∏–Ω—ã –∏ –ª–∏—à–Ω–µ–µ
                                    name = re.sub(r'\s*-\s*[–ê-–Ø–∞-—è–Å—ëA-Za-z\s]+\.ru.*$', '', name, flags=re.IGNORECASE)
                                    name = re.sub(r'\s*-\s*–∫—É–ø–∏—Ç—å.*$', '', name, flags=re.IGNORECASE)
                                    name = re.sub(r'\s*-\s*—Ü–µ–Ω–∞.*$', '', name, flags=re.IGNORECASE)
                                    # –§–∏–ª—å—Ç—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ Google
                                    if is_valid_product_name(name) and len(name) > 5:
                                        if 'google' not in name.lower() and '–ø–æ–∏—Å–∫' not in name.lower():
                                            product_name = name
                                            break
                                if product_name:
                                    break
                            
                            if product_name and is_valid_product_name(product_name):
                                logger.info(f"–ü—Ä–æ–¥—É–∫—Ç –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ Google: {product_name}")
                                return {
                                    'success': True,
                                    'name': product_name,
                                    'calories_per_100g': None,
                                    'proteins_per_100g': None,
                                    'fats_per_100g': None,
                                    'carbs_per_100g': None,
                                    'weight': None,
                                    'barcode': barcode,
                                    'brand': '',
                                    'image_url': None,
                                    'source': 'Google Search'
                                }
                except Exception as e:
                    logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≤ Google: {e}")
                    
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–º –≤–µ–±-–ø–æ–∏—Å–∫–µ –¥–ª—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ {barcode}: {e}")
        
        return None
    
    
    async def get_product_info_by_barcode(self, barcode: str, status_callback=None) -> Dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–¥—É–∫—Ç–µ –ø–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥—É (–±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –¥–Ω–µ–≤–Ω–∏–∫)
        
        Args:
            barcode: –®—Ç—Ä–∏—Ö-–∫–æ–¥ –ø—Ä–æ–¥—É–∫—Ç–∞
            status_callback: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–∏—Å–∫–∞ (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Ç—Ä–æ–∫—É —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º)
        """
        product_info = await self.search_product_by_barcode(barcode, status_callback=status_callback)
        
        if not product_info or not product_info.get('success'):
            return {
                'success': False,
                'message': '–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Open Food Facts.'
            }
        
        return product_info
    
    async def add_meal_from_barcode(self, user_id: int, barcode: str, status_callback=None) -> Dict:
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏ –ø–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥—É"""
        product_info = await self.search_product_by_barcode(barcode)
        
        if not product_info or not product_info.get('success'):
            return {
                'success': False,
                'message': '–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π –¥–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é, –æ–ø–∏—Å–∞–≤ —á—Ç–æ —Ç—ã —Å—ä–µ–ª.'
            }
        
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–∞–ª–æ—Ä–∏–∏ –∏ –ö–ë–ñ–£
        calories_per_100g = product_info.get('calories_per_100g', 250)
        proteins_per_100g = product_info.get('proteins_per_100g')
        fats_per_100g = product_info.get('fats_per_100g')
        carbs_per_100g = product_info.get('carbs_per_100g')
        weight = product_info.get('weight')
        product_name = product_info.get('name', '')
        source = product_info.get('source', '–®—Ç—Ä–∏—Ö-–∫–æ–¥')
        
        # –ï—Å–ª–∏ –≤–µ—Å –Ω–µ –±—ã–ª –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ, –ø—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
        if weight is None and product_name:
            name_weight_match = re.search(r'(\d+)\s*(–≥|g|–∫–≥|kg)\b', product_name, re.IGNORECASE)
            if name_weight_match:
                weight = float(name_weight_match.group(1))
                unit = name_weight_match.group(2).lower()
                if unit in ['–∫–≥', 'kg']:
                    weight *= 1000
                logger.info(f"–í–µ—Å {weight}–≥ –∏–∑–≤–ª–µ—á–µ–Ω –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞: {product_name}")
        
        # –ï—Å–ª–∏ –≤–µ—Å –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–µ—Å –ø–æ —Ç–∏–ø—É –ø—Ä–æ–¥—É–∫—Ç–∞
        if weight is None:
            product_name_lower = product_name.lower()
            # –ë–∞—Ç–æ–Ω—á–∏–∫–∏ –æ–±—ã—á–Ω–æ –≤–µ—Å—è—Ç 50-60–≥
            if any(word in product_name_lower for word in ['–±–∞—Ç–æ–Ω—á–∏–∫', 'bar', '–±–∞—Ç–æ–Ω']):
                weight = 60  # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–µ—Å –±–∞—Ç–æ–Ω—á–∏–∫–∞
                logger.info(f"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–µ—Å –±–∞—Ç–æ–Ω—á–∏–∫–∞ (60–≥) –¥–ª—è: {product_name}")
            # –ü–µ—á–µ–Ω—å–µ –æ–±—ã—á–Ω–æ 10-15–≥ –Ω–∞ —à—Ç—É–∫—É
            elif any(word in product_name_lower for word in ['–ø–µ—á–µ–Ω—å–µ', 'cookie', '–±–∏—Å–∫–≤–∏—Ç']):
                weight = 12  # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–µ—Å –ø–µ—á–µ–Ω—å—è
                logger.info(f"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–µ—Å –ø–µ—á–µ–Ω—å—è (12–≥) –¥–ª—è: {product_name}")
            # –ö–æ–Ω—Ñ–µ—Ç—ã –æ–±—ã—á–Ω–æ 5-10–≥ –Ω–∞ —à—Ç—É–∫—É
            elif any(word in product_name_lower for word in ['–∫–æ–Ω—Ñ–µ—Ç', 'candy', '—à–æ–∫–æ–ª–∞–¥']):
                weight = 8  # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–µ—Å –∫–æ–Ω—Ñ–µ—Ç—ã
                logger.info(f"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–µ—Å –∫–æ–Ω—Ñ–µ—Ç—ã (8–≥) –¥–ª—è: {product_name}")
        
        proteins = None
        fats = None
        carbs = None
        
        if weight:
            # –ï—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–µ–Ω –≤–µ—Å –ø—Ä–æ–¥—É–∫—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            calories = int((calories_per_100g / 100) * weight)
            meal_name = f"{product_name} {int(weight)}–≥"
            if proteins_per_100g is not None:
                proteins = round((proteins_per_100g / 100) * weight, 1)
            if fats_per_100g is not None:
                fats = round((fats_per_100g / 100) * weight, 1)
            if carbs_per_100g is not None:
                carbs = round((carbs_per_100g / 100) * weight, 1)
            logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω –ø—Ä–æ–¥—É–∫—Ç —Å –≤–µ—Å–æ–º: {product_name}, –≤–µ—Å={weight}–≥, –∫–∞–ª–æ—Ä–∏–∏={calories} –∫–∫–∞–ª (–Ω–∞ 100–≥: {calories_per_100g})")
        else:
            # –ï—Å–ª–∏ –≤–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω –∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º 100–≥
            # –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            logger.warning(f"–í–µ—Å –ø—Ä–æ–¥—É–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω: {product_name}, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 100–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
            calories = calories_per_100g
            meal_name = f"{product_name} 100–≥"
            if proteins_per_100g is not None:
                proteins = round(proteins_per_100g, 1)
            if fats_per_100g is not None:
                fats = round(fats_per_100g, 1)
            if carbs_per_100g is not None:
                carbs = round(carbs_per_100g, 1)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        conn = self.get_connection()
        cursor = conn.cursor()
        
        today = date.today()
        cursor.execute("""
            INSERT INTO meals (user_id, meal_name, calories, date, source, proteins, fats, carbs)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        """, (user_id, meal_name, calories, today, source, proteins, fats, carbs))
        
        meal_id = cursor.lastrowid
        conn.commit()
        conn.close()
        
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–ª–æ—Ä–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è
        total_today = self.get_today_stats(user_id)['calories']
        
        return {
            'success': True,
            'calories': calories,
            'total_today': total_today,
            'product_name': product_info['name'],
            'brand': product_info.get('brand', ''),
            'product_info': product_info,  # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–¥—É–∫—Ç–µ
            'source': source,
            'meal_id': meal_id,
            'proteins': proteins,
            'fats': fats,
            'carbs': carbs
        }
